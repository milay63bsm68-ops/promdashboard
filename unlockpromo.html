<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unlock Promo Earnings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #050a14;
  --surface: #0b1526;
  --surface2: #111e35;
  --border: #1a2d4d;
  --accent: #00e5a0;
  --accent2: #3b9eff;
  --accent3: #f59e0b;
  --text: #e2eaf6;
  --muted: #4a6080;
  --danger: #ff4d6d;
}
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg); color: var(--text);
  font-family: 'Syne', sans-serif; min-height: 100vh;
  overflow-x: hidden; padding-bottom: 40px;
}
body::before {
  content: ''; position: fixed; top: -200px; right: -200px;
  width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(0,229,160,0.06) 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}
body::after {
  content: ''; position: fixed; bottom: -200px; left: -100px;
  width: 400px; height: 400px;
  background: radial-gradient(circle, rgba(59,158,255,0.06) 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
.top-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(5,10,20,0.92); backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 14px 20px; display: flex; align-items: center; gap: 12px;
}
.back-btn {
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--text); border-radius: 10px; padding: 7px 14px;
  font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
}
.back-btn:hover { border-color: var(--accent); color: var(--accent); }
.page-title {
  font-size: 16px; font-weight: 800;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

/* â”€â”€â”€ CONTAINER â”€â”€â”€ */
.container {
  max-width: 480px; margin: 0 auto;
  padding: 20px 16px; position: relative; z-index: 1;
}

/* â”€â”€â”€ PROFILE ROW â”€â”€â”€ */
.profile-card {
  background: linear-gradient(135deg, var(--surface) 0%, #0d1e38 100%);
  border: 1px solid var(--border); border-radius: 18px;
  padding: 16px 18px; margin-bottom: 14px;
  display: flex; align-items: center; gap: 12px;
  position: relative; overflow: hidden;
  animation: fadeUp 0.4s ease;
}
.profile-card::before {
  content: ''; position: absolute; top: 0; right: 0;
  width: 100px; height: 100px;
  background: radial-gradient(circle, rgba(0,229,160,0.08) 0%, transparent 70%);
}
.avatar {
  width: 44px; height: 44px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent2), var(--accent));
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; flex-shrink: 0; border: 2px solid rgba(0,229,160,0.3);
}
.profile-info { flex: 1; }
.profile-name { font-size: 14px; font-weight: 700; }
.profile-meta { font-size: 11px; color: var(--muted); font-family: 'DM Mono', monospace; margin-top: 3px; }

/* â”€â”€â”€ BALANCE DISPLAY â”€â”€â”€ */
.balance-strip {
  background: linear-gradient(135deg, #061a10 0%, #0a2218 50%, #051420 100%);
  border: 1px solid rgba(0,229,160,0.25); border-radius: 16px;
  padding: 16px 20px; margin-bottom: 14px;
  display: flex; align-items: center; justify-content: space-between;
  animation: fadeUp 0.45s ease;
}
.bal-label { font-size: 11px; letter-spacing: 1.2px; color: var(--accent); text-transform: uppercase; margin-bottom: 4px; }
.bal-ngn { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
.bal-usd { font-size: 12px; color: var(--muted); font-family: 'DM Mono', monospace; margin-top: 2px; }
.bal-icon { font-size: 36px; opacity: 0.3; }

/* â”€â”€â”€ CARD â”€â”€â”€ */
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 18px; padding: 20px; margin-bottom: 14px;
  animation: fadeUp 0.5s ease;
}
.card-title {
  font-size: 15px; font-weight: 700; margin-bottom: 6px;
  display: flex; align-items: center; gap: 8px;
}
.card-sub { font-size: 13px; color: var(--muted); line-height: 1.7; }

/* â”€â”€â”€ PRICE BADGE â”€â”€â”€ */
.price-row {
  display: flex; align-items: center; gap: 10px; margin: 14px 0;
  flex-wrap: wrap;
}
.price-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(0,229,160,0.1); border: 1px solid rgba(0,229,160,0.3);
  border-radius: 50px; padding: 7px 18px;
  font-size: 20px; font-weight: 800; color: var(--accent);
  font-family: 'DM Mono', monospace;
}
.price-badge small { font-size: 11px; color: var(--muted); font-weight: 400; font-family: 'Syne', sans-serif; }

/* â”€â”€â”€ INPUT â”€â”€â”€ */
input, select {
  width: 100%; padding: 13px 14px; margin-top: 10px;
  border-radius: 12px; border: 1px solid var(--border);
  background: var(--surface2); color: var(--text);
  font-family: 'Syne', sans-serif; font-size: 14px;
  outline: none; transition: border-color 0.2s;
}
input:focus, select:focus { border-color: var(--accent); }
select option { background: #0b1526; }
.field-label { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-top: 16px; display: block; }
.field-hint  { font-size: 12px; color: var(--muted); margin-top: 5px; line-height: 1.5; }

/* â”€â”€â”€ STEP NUMBER â”€â”€â”€ */
.step-row {
  display: flex; gap: 10px; align-items: flex-start; margin-bottom: 12px;
}
.step-num {
  min-width: 28px; height: 28px; border-radius: 50%;
  background: rgba(0,229,160,0.15); border: 1px solid rgba(0,229,160,0.3);
  color: var(--accent); font-size: 13px; font-weight: 800;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px;
}
.step-text { font-size: 13px; color: var(--muted); line-height: 1.6; }
.step-text strong { color: var(--text); }

/* â”€â”€â”€ PASSCODE INPUT BOX â”€â”€â”€ */
.passcode-wrapper { display: none; }
.passcode-wrapper.show { display: block; }
.passcode-note {
  font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.6;
}
.passcode-note a { color: var(--accent2); }

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%; padding: 15px; border: none; border-radius: 14px;
  font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700;
  cursor: pointer; margin-top: 12px; transition: all 0.2s ease;
  letter-spacing: 0.3px; text-decoration: none;
}
.btn:active { transform: scale(0.97); }
.btn-green  { background: linear-gradient(135deg, #065f46, var(--accent));  color: white; box-shadow: 0 4px 20px rgba(0,229,160,0.25); }
.btn-blue   { background: linear-gradient(135deg, #1e40af, var(--accent2)); color: white; box-shadow: 0 4px 20px rgba(59,158,255,0.25); }
.btn-amber  { background: linear-gradient(135deg, #78350f, var(--accent3)); color: white; box-shadow: 0 4px 20px rgba(245,158,11,0.2); }
.btn-copy   { background: var(--surface2); border: 1px solid var(--border); color: var(--accent2); }
.btn-dark   { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none !important; }
.btn:not(:disabled):hover { filter: brightness(1.1); }

/* â”€â”€â”€ STATUS â”€â”€â”€ */
.status {
  margin-top: 12px; padding: 13px 16px; border-radius: 12px;
  font-size: 13px; line-height: 1.6; display: none;
}
.status.show    { display: block; }
.status.success { background: rgba(0,229,160,0.1);  border: 1px solid rgba(0,229,160,0.3);  color: var(--accent);  }
.status.error   { background: rgba(255,77,109,0.1); border: 1px solid rgba(255,77,109,0.3); color: var(--danger);  }
.status.loading { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); color: var(--accent3); }

/* â”€â”€â”€ ALREADY UNLOCKED CARD â”€â”€â”€ */
.already-card {
  display: none;
  background: linear-gradient(135deg, rgba(0,229,160,0.08), rgba(0,229,160,0.03));
  border: 1px solid rgba(0,229,160,0.3); border-radius: 18px;
  padding: 24px; text-align: center; margin-bottom: 14px;
}
.already-card.show { display: block; animation: fadeUp 0.4s ease; }
.already-card .s-icon { font-size: 50px; margin-bottom: 14px; }
.already-card h2 { font-size: 18px; font-weight: 800; color: var(--accent); margin-bottom: 8px; }
.already-card p  { font-size: 13px; color: var(--muted); line-height: 1.8; margin-bottom: 4px; }

/* â”€â”€â”€ SUCCESS CARD â”€â”€â”€ */
.success-card {
  display: none;
  background: linear-gradient(135deg, rgba(0,229,160,0.08), rgba(0,229,160,0.03));
  border: 1px solid rgba(0,229,160,0.3); border-radius: 18px;
  padding: 24px; text-align: center; margin-bottom: 14px;
}
.success-card.show { display: block; animation: fadeUp 0.4s ease; }
.success-card .s-icon { font-size: 50px; margin-bottom: 14px; }
.success-card h2 { font-size: 18px; font-weight: 800; color: var(--accent); margin-bottom: 8px; }
.success-card p  { font-size: 13px; color: var(--muted); line-height: 1.8; }
.promo-result-box {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 12px; padding: 14px; margin: 14px 0; text-align: left;
}
.promo-result-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
.promo-result-value { font-size: 14px; font-family: 'DM Mono', monospace; color: var(--accent2); word-break: break-all; }

/* â”€â”€â”€ LOADING OVERLAY â”€â”€â”€ */
.page-loader {
  display: flex; align-items: center; justify-content: center;
  gap: 10px; padding: 30px; border-radius: 18px;
  background: var(--surface); border: 1px solid var(--border);
  margin-bottom: 14px; font-size: 13px; color: var(--muted);
  animation: fadeUp 0.3s ease;
}
.spinner {
  width: 20px; height: 20px; border: 2px solid var(--border);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.8s linear infinite; flex-shrink: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(14px); }
  to   { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="top-header">
  <button class="back-btn" onclick="location.href='dashboard.html'">â† Back</button>
  <div class="page-title">ğŸ”“ Unlock Promo</div>
</div>

<div class="container">

  <!-- PROFILE -->
  <div class="profile-card">
    <div class="avatar">ğŸ‘¤</div>
    <div class="profile-info">
      <div class="profile-name" id="uName">Loading...</div>
      <div class="profile-meta" id="uMeta">â€”</div>
    </div>
  </div>

  <!-- BALANCE -->
  <div class="balance-strip">
    <div>
      <div class="bal-label">Your Balance</div>
      <div class="bal-ngn" id="balNgn">â‚¦â€”</div>
      <div class="bal-usd" id="balUsd">â‰ˆ $â€”</div>
    </div>
    <div class="bal-icon">ğŸ’°</div>
  </div>

  <!-- PAGE LOADER (shown while checking promo status) -->
  <div class="page-loader" id="pageLoader">
    <div class="spinner"></div>
    Checking your promo status...
  </div>

  <!-- ALREADY UNLOCKED STATE -->
  <div class="already-card" id="alreadyCard">
    <div class="s-icon">âœ…</div>
    <h2>You're Already Unlocked!</h2>
    <p>Your promo access is <strong style="color:var(--accent);">active</strong>. You don't need to buy it again.</p>
    <p style="margin-top:8px;">Your promo code and link are below â€” share them and keep earning!</p>
    <div class="promo-result-box">
      <div class="promo-result-label">Your Promo Code</div>
      <div class="promo-result-value" id="alreadyCode">â€”</div>
    </div>
    <div class="promo-result-box">
      <div class="promo-result-label">Your Promo Link</div>
      <div class="promo-result-value" id="alreadyLink">â€”</div>
    </div>
    <button class="btn btn-copy" onclick="copyText(document.getElementById('alreadyLink').textContent, 'Promo link')">
      ğŸ”— Copy Promo Link
    </button>
    <button class="btn btn-dark" style="margin-top:8px;" onclick="location.href='dashboard.html'">
      ğŸ  Back to Dashboard
    </button>
  </div>

  <!-- SUCCESS STATE (hidden until purchase complete) -->
  <div class="success-card" id="successCard">
    <div class="s-icon">ğŸ‰</div>
    <h2>Promo Unlocked!</h2>
    <p>Your promo code is now live. Share your link and earn commission!</p>
    <div class="promo-result-box">
      <div class="promo-result-label">Your Promo Code</div>
      <div class="promo-result-value" id="resultCode">â€”</div>
    </div>
    <div class="promo-result-box">
      <div class="promo-result-label">Your Promo Link</div>
      <div class="promo-result-value" id="resultLink">â€”</div>
    </div>
    <button class="btn btn-copy" onclick="copyText(document.getElementById('resultLink').textContent, 'Promo link')">
      ğŸ”— Copy Promo Link
    </button>
    <button class="btn btn-dark" style="margin-top:8px;" onclick="location.href='dashboard.html'">
      ğŸ  Back to Dashboard
    </button>
  </div>

  <!-- INTRO + PAY CARD (hidden if already unlocked) -->
  <div id="mainContent" style="display:none;">

    <!-- INTRO CARD -->
    <div class="card" id="introCard">
      <div class="card-title"><span>ğŸ¯</span> Get Your Promo Access</div>
      <div class="card-sub">
        Unlock your personal promo code and earn commission every time someone buys using your link.
      </div>
      <div class="price-row">
        <div class="price-badge">â‚¦2,000 <small>one-time fee</small></div>
      </div>
    </div>

    <!-- PAY FROM BALANCE (passcode flow) -->
    <div class="card">
      <div class="card-title"><span>ğŸ’³</span> Pay â‚¦2,000 from Balance</div>

      <div style="margin-bottom:16px;">
        <div class="step-row">
          <div class="step-num">1</div>
          <div class="step-text">
            Make sure your balance is <strong>â‚¦2,000 or more</strong>.
            If not, <a href="https://t.me/intelligentpublicgroupsbot/deposit" target="_blank" style="color:var(--accent2);">deposit here</a>.
          </div>
        </div>
        <div class="step-row">
          <div class="step-num">2</div>
          <div class="step-text">
            Click <strong>"Generate Passcode"</strong> â€” a 6-digit code is sent to your Telegram.
            This proves it is really you authorising the deduction.
          </div>
        </div>
        <div class="step-row">
          <div class="step-num">3</div>
          <div class="step-text">
            Enter the code and click <strong>"Unlock Promo"</strong>.
            â‚¦2,000 is deducted and your promo code goes live instantly!
          </div>
        </div>
      </div>

      <!-- GENERATE PASSCODE -->
      <button class="btn btn-dark" id="genPasscodeBtn" onclick="generatePasscode()">
        ğŸ”‘ Generate Passcode
      </button>

      <!-- PASSCODE INPUT -->
      <div class="passcode-wrapper" id="passcodeWrapper">
        <span class="field-label">Enter Passcode</span>
        <input type="number" id="passcodeInput" placeholder="6-digit code from Telegram">
        <div class="passcode-note">
          Check <a href="https://t.me/intelpremiumbot" target="_blank">@intelpremiumbot</a> on Telegram for your code.
          It expires in 5 minutes.
        </div>
        <button class="btn btn-green" id="buyPromoBtn" onclick="buyPromo()">
          ğŸš€ Unlock Promo â€” â‚¦2,000
        </button>
      </div>

      <div class="status" id="payStatus"></div>
    </div>

  </div><!-- /mainContent -->

</div><!-- /container -->

<script>
const tg      = window.Telegram.WebApp; tg.ready();
const SERVER  = "";   /* same origin â€” server.js serves these files */

const user       = tg.initDataUnsafe?.user || {};
const telegramId = user.id ? String(user.id) : null;
const name       = user.first_name || "Guest";
const username   = user.username ? "@" + user.username : "No username";

/* â”€â”€â”€ UI REFS â”€â”€â”€ */
const uName          = document.getElementById("uName");
const uMeta          = document.getElementById("uMeta");
const balNgn         = document.getElementById("balNgn");
const balUsd         = document.getElementById("balUsd");
const genPasscodeBtn = document.getElementById("genPasscodeBtn");
const passcodeWrapper= document.getElementById("passcodeWrapper");
const buyPromoBtn    = document.getElementById("buyPromoBtn");
const payStatus      = document.getElementById("payStatus");
const successCard    = document.getElementById("successCard");
const alreadyCard    = document.getElementById("alreadyCard");
const mainContent    = document.getElementById("mainContent");
const pageLoader     = document.getElementById("pageLoader");
const introCard      = document.getElementById("introCard");

uName.textContent = name;
uMeta.textContent = username + " Â· ID: " + (telegramId || "N/A");

let ngnPerUsd = 1600;

/* â”€â”€â”€ LOAD BALANCE â”€â”€â”€ */
async function loadBalance() {
  if (!telegramId) return;
  try {
    const r = await fetch(SERVER + "/get-balance", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ telegramId })
    });
    const d = await r.json();
    if (d.usdRate && d.usdRate > 100) ngnPerUsd = d.usdRate;
    const ngn = d.ngn || 0;
    balNgn.textContent = "â‚¦" + ngn.toLocaleString();
    balUsd.textContent = "â‰ˆ $" + (ngn / ngnPerUsd).toFixed(2) + " USD";
  } catch {
    balNgn.textContent = "â‚¦â€”";
    balUsd.textContent = "Error loading";
  }
}

/* â”€â”€â”€ CHECK PROMO STATUS ON LOAD â”€â”€â”€ */
async function checkPromoStatus() {
  if (!telegramId) {
    pageLoader.style.display = "none";
    mainContent.style.display = "block";
    return;
  }

  try {
    const r = await fetch(SERVER + "/check-promo-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ telegramId })
    });
    const d = await r.json();

    pageLoader.style.display = "none";

    if (d.hasPromo) {
      /* User already has promo â€” show the already-unlocked card */
      document.getElementById("alreadyCode").textContent = d.promoCode;
      document.getElementById("alreadyLink").textContent = d.promoLink;
      alreadyCard.classList.add("show");
    } else {
      /* Not yet unlocked â€” show the payment form */
      mainContent.style.display = "block";
    }
  } catch {
    /* On error, just show the payment form */
    pageLoader.style.display = "none";
    mainContent.style.display = "block";
  }
}

/* Boot */
loadBalance();
checkPromoStatus();

/* â”€â”€â”€ STATUS HELPER â”€â”€â”€ */
function setStatus(el, msg, type) {
  el.textContent = msg;
  el.className = "status show " + type;
}
function clearStatus(el) { el.className = "status"; }

/* â”€â”€â”€ GENERATE PASSCODE â”€â”€â”€ */
async function generatePasscode() {
  if (!telegramId) return setStatus(payStatus, "âŒ Open this page from Telegram.", "error");
  setStatus(payStatus, "â³ Sending passcode to your Telegram...", "loading");
  genPasscodeBtn.disabled = true;

  try {
    const r = await fetch(SERVER + "/generate-passcode", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ telegramId, purpose: "promo" })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || "Failed");

    setStatus(payStatus, "âœ… Passcode sent to your Telegram! Enter it below.", "success");
    passcodeWrapper.classList.add("show");
    genPasscodeBtn.textContent = "ğŸ” Resend Passcode";
    genPasscodeBtn.disabled    = false;
  } catch (err) {
    setStatus(payStatus, "âŒ " + err.message, "error");
    genPasscodeBtn.disabled = false;
  }
}

/* â”€â”€â”€ BUY PROMO (passcode-verified balance deduction) â”€â”€â”€ */
async function buyPromo() {
  const passcode = document.getElementById("passcodeInput").value.trim();
  if (!passcode) return setStatus(payStatus, "âŒ Enter the passcode from Telegram.", "error");
  if (!telegramId) return setStatus(payStatus, "âŒ Open this page from Telegram.", "error");

  setStatus(payStatus, "â³ Verifying passcode and deducting â‚¦2,000...", "loading");
  buyPromoBtn.disabled = true;

  try {
    const r = await fetch(SERVER + "/buy-promo", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ telegramId, name, username, passcode })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || "Failed");

    /* Show success state */
    introCard.style.display      = "none";
    mainContent.style.display    = "none";

    document.getElementById("resultCode").textContent = d.promoCode;
    document.getElementById("resultLink").textContent = d.promoLink;
    successCard.classList.add("show");

    /* Update balance display */
    balNgn.textContent = "â‚¦" + d.newBalance.toLocaleString();
    balUsd.textContent = "â‰ˆ $" + (d.newBalance / ngnPerUsd).toFixed(2) + " USD";

    clearStatus(payStatus);
  } catch (err) {
    setStatus(payStatus, "âŒ " + err.message, "error");
    buyPromoBtn.disabled = false;
  }
}

/* â”€â”€â”€ COPY TEXT â”€â”€â”€ */
function copyText(text, label) {
  navigator.clipboard.writeText(text);
  const t = document.createElement("div");
  t.textContent = "âœ… " + (label || "Copied") + "!";
  t.style.cssText = `
    position:fixed;bottom:30px;left:50%;transform:translateX(-50%);
    background:#00e5a0;color:#050a14;padding:10px 24px;border-radius:50px;
    font-family:'Syne',sans-serif;font-weight:700;font-size:13px;z-index:9999;
  `;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2200);
}
</script>
</body>
</html>
