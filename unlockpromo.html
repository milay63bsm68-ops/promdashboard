<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unlock Promo Earnings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  background:#020617;
  color:white;
  font-family:Arial, sans-serif;
  padding:20px;
}
.container {
  max-width:480px;
  margin:auto;
}
.card {
  background:#0f172a;
  padding:16px;
  border-radius:14px;
  margin-bottom:15px;
}
button {
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  margin-top:10px;
  cursor:pointer;
}
.primary { background:#22c55e; color:white; }
.secondary { background:#3b82f6; color:white; }
.whatsapp { background:#25D366; color:white; }
.copy { background:#334155; color:white; font-size:13px; }
input {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  margin-top:10px;
  background:#020617;
  color:white;
  height:26px;
}
select {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  margin-top:10px;
  background:#020617;
  color:white;
  height:50px;
}
.status {
  margin-top:10px;
  font-size:14px;
  text-align:center;
}
.hidden { display:none; }
.addressBox {
  margin-top:12px;
  padding:14px;
  background:#020617;
  border-radius:10px;
  font-size:14px;
  line-height:1.6;
}
.small {
  font-size:12px;
  opacity:0.85;
}
.amount {
  color:#22c55e;
  font-weight:bold;
  font-size:16px;
}
</style>
</head>

<body>
<div class="container">

  <div class="card" id="userInfo">Loading user info...</div>

  <div class="card">
    <b>üîì Unlock Promo Earnings</b><br><br>
    Choose how you want to unlock üëá
  </div>

  <div class="card">
    <button class="primary" onclick="showTask()">‚úÖ Complete Simple Task</button>
    <center>
      <strong>
        <p>
    OR
    </p>
    </strong>
    </center>
    <button class="secondary" onclick="showPurchase()">üí≥ Purchase Access</button>
  </div>

  <!-- TASK -->
  <div class="card hidden" id="taskBox">
    <b>üìå Task</b><br><br>
    1Ô∏è‚É£ Join WhatsApp group<br>
    2Ô∏è‚É£ Invite <b>10 people</b><br>
    3Ô∏è‚É£ Upload <b>screenshots or any proof</b><br><br>

    <a href="https://chat.whatsapp.com/FVt9vJB1sbJ9q5LTQ0nB3O?mode=gi_t" target="_blank">
      <button class="whatsapp">üì≤ Join WhatsApp Group</button>
    </a>

    <button class="copy" onclick="copyText('https://chat.whatsapp.com/FVt9vJB1sbJ9q5LTQ0nB3O?mode=gi_t')">
      üìã Copy WhatsApp Group Link
    </button>

    <input id="taskWhatsapp" placeholder="Your WhatsApp number">
    <input id="taskCall" placeholder="Calling number">
    <input type="file" accept="image/*" id="taskShot" multiple>

    <button class="primary" onclick="submitTask()">Submit Task</button>
    <div class="status" id="taskStatus"></div>
  </div>

  <!-- PURCHASE -->
  <div class="card hidden" id="purchaseBox">
    <b>üí≥ Select Payment Method</b>

    <select id="payMethod" onchange="updatePaymentAddress()">
      <option value="">Select method</option>
      <option value="bank">Bank Transfer</option>
      <option value="bnb">BNB Smart Chain (BEP20)</option>
    </select>

    <div id="paymentAddress" class="addressBox hidden"></div>

    <input id="payWhatsapp" placeholder="Your WhatsApp number">
    <input id="payCall" placeholder="Calling number">
    <input type="file" accept="image/*" id="payShot">

    <button class="secondary" onclick="submitPayment()">Submit Payment</button>
    <div class="status" id="payStatus"></div>
  </div>

</div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const BACKEND = "https://promo-oz59.onrender.com";
const user = tg.initDataUnsafe?.user || {};

const telegramId = user.id;
const name = user.first_name || "Guest";
const username = user.username ? "@"+user.username : "No username";

userInfo.innerHTML = `
<b>Name:</b> ${name}<br>
<b>Username:</b> ${username}<br>
<b>ID:</b> ${telegramId || "Not available"}
`;

function showTask(){
  taskBox.classList.remove("hidden");
  purchaseBox.classList.add("hidden");
  taskStatus.innerHTML = "";
}

function showPurchase(){
  purchaseBox.classList.remove("hidden");
  taskBox.classList.add("hidden");
  payStatus.innerHTML = "";
}

function updatePaymentAddress(){
  const box = paymentAddress;

  if(payMethod.value === "bank"){
    box.innerHTML = `
<b>üè¶ Bank Transfer</b><br><br>

<b>üí∞ Amount to Pay:</b><br>
<span class="amount">‚Ç¶2,000 (exactly)</span><br><br>

Account Name: Olatunji Abdulmalik Ayomide<br>
Account Number: 9114301708<br>
Bank: Opay<br><br>

<span class="small">‚ö†Ô∏è Pay the exact amount. Overpayment or underpayment may delay approval.</span><br><br>

<button class="copy" onclick="copyText('9114301708')">üìã Copy Account Number</button>
`;
    box.classList.remove("hidden");

  } else if(payMethod.value === "bnb"){
    box.innerHTML = `
<b>üíé Crypto Payment (BNB Smart Chain ‚Äì BEP20)</b><br><br>

<b>üí∞ Amount to Pay:</b><br>
<span class="amount">$4.5 (USD)</span><br><br>

<b>Network:</b> BNB Smart Chain (BEP20)<br>
<b>Wallet Address:</b><br>
0xbBcc409872bC2441400735624638F3D67DAa7C4C<br><br>

<span class="small">‚ö†Ô∏è Send only BNB on BEP20 network.</span><br><br>

<button class="copy" onclick="copyText('0xbBcc409872bC2441400735624638F3D67DAa7C4C')">
üìã Copy BNB Address
</button>
`;
    box.classList.remove("hidden");

  } else {
    box.classList.add("hidden");
  }
}

function copyText(text){
  navigator.clipboard.writeText(text);
  tg.showAlert("Copied ‚úÖ");
}

/* ===== BASE64 ===== */
function toBase64(file){
  return new Promise((resolve, reject)=>{
    if(file.size > 5 * 1024 * 1024) return reject(new Error("Image too large"));

    const reader = new FileReader();
    const img = new Image();

    reader.onload = e => img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.getContext("2d").drawImage(img,0,0);
      resolve(canvas.toDataURL("image/jpeg",0.85));
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ===== BACK TO DASHBOARD BUTTON ===== */
function showBackToDashboard(targetElement){
  const existing = document.getElementById("backDashboardBtn");
  if(existing) existing.remove();

  const btn = document.createElement("button");
  btn.id = "backDashboardBtn";
  btn.className = "secondary";
  btn.innerText = "‚¨Ö Back to Dashboard";
  btn.onclick = () => window.location.href = "dashboard.html";

  targetElement.appendChild(btn);
}

/* ===== SUBMIT TASK ===== */
async function submitTask(){
  if(!telegramId) return taskStatus.innerHTML = "‚ùå Open from Telegram";
  if(!taskShot.files.length) return taskStatus.innerHTML = "‚ùå Upload screenshot";

  taskStatus.innerHTML = "‚è≥ Sending...";

  try{
    for(const f of taskShot.files){
      const image = await toBase64(f);
      await fetch(BACKEND+"/unlock-promo",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          telegramId,name,username,
          method:"Task",
          whatsapp:taskWhatsapp.value||"N/A",
          call:taskCall.value||"N/A",
          image,type:"task"
        })
      });
    }
    taskStatus.innerHTML = "‚úÖ Task submitted";
    tg.showAlert("Task submitted ‚úÖ");

    // Show Back to Dashboard button
    showBackToDashboard(taskBox);

  }catch(e){
    taskStatus.innerHTML = "‚ùå " + e.message;
  }
}

/* ===== SUBMIT PAYMENT ===== */
async function submitPayment(){
  if(!telegramId) return payStatus.innerHTML = "‚ùå Open from Telegram";
  if(!payShot.files[0] || !payMethod.value) return payStatus.innerHTML = "‚ùå Missing data";

  payStatus.innerHTML = "‚è≥ Sending...";

  try{
    const image = await toBase64(payShot.files[0]);
    await fetch(BACKEND+"/unlock-promo",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        telegramId,name,username,
        method:payMethod.value,
        whatsapp:payWhatsapp.value||"N/A",
        call:payCall.value||"N/A",
        image,type:"payment"
      })
    });
    payStatus.innerHTML = "‚úÖ Payment sent";
    tg.showAlert("Payment submitted ‚úÖ");

    // Show Back to Dashboard button
    showBackToDashboard(purchaseBox);

  }catch(e){
    payStatus.innerHTML = "‚ùå " + e.message;
  }
}
</script>
</body>
</html>