<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unlock Promo Earnings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  background:#020617;
  color:white;
  font-family:Arial, sans-serif;
  padding:20px;
}
.container {
  max-width:480px;
  margin:auto;
}
.card {
  background:#0f172a;
  padding:16px;
  border-radius:14px;
  margin-bottom:15px;
}
button {
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  margin-top:10px;
  cursor:pointer;
}
.primary { background:#22c55e; color:white; }
.secondary { background:#3b82f6; color:white; }
.whatsapp { background:#25D366; color:white; }
.copy { background:#334155; color:white; font-size:13px; }
input, select {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  margin-top:10px;
  background:#020617;
  color:white;
  height:40px;
}
.status {
  margin-top:10px;
  font-size:14px;
  text-align:center;
}
.hidden { display:none; }
.addressBox {
  margin-top:12px;
  padding:14px;
  background:#020617;
  border-radius:10px;
  font-size:14px;
  line-height:1.6;
}
.small {
  font-size:12px;
  opacity:0.85;
}
</style>
</head>

<body>
<div class="container">

  <!-- USER INFO -->
  <div class="card" id="userInfo">Loading user info...</div>

  <!-- BOT LINK -->
  <div class="card">
    <b>ü§ñ Promo Bot</b><br><br>
    <a href="https://t.me/intelpremiumbot" target="_blank">
      <button class="secondary">ü§ñ Open Bot</button>
    </a>
  </div>

  <!-- UNLOCK OPTIONS -->
  <div class="card">
    <b>üîì Unlock Promo Earnings</b><br><br>
    Choose how you want to unlock üëá
  </div>

  <!-- TEST CONNECTION -->
  <div class="card">
    <button class="copy" onclick="testConnection()">üîç Test Server Connection</button>
    <div class="status" id="testStatus"></div>
  </div>

  <div class="card">
    <button class="primary" onclick="showTask()">‚úÖ Complete Simple Task</button>
    <button class="secondary" onclick="showPurchase()">üí≥ Purchase Access</button>
  </div>

  <!-- TASK -->
  <div class="card hidden" id="taskBox">
    <b>üìå Task</b><br><br>
    1Ô∏è‚É£ Join WhatsApp group<br>
    2Ô∏è‚É£ Invite <b>10 people</b><br><br>

    <a href="https://chat.whatsapp.com/FVt9vJB1sbJ9q5LTQ0nB3O?mode=gi_t" target="_blank">
      <button class="whatsapp">üì≤ Join WhatsApp Group</button>
    </a>
    <button class="copy" onclick="copyText('https://chat.whatsapp.com/FVt9vJB1sbJ9q5LTQ0nB3O?mode=gi_t')">
      üìã Copy WhatsApp Group Link
    </button>

    <input id="taskWhatsapp" placeholder="Your WhatsApp number">
    <input id="taskCall" placeholder="Calling number">
    <input type="file" accept="image/*" id="taskShot" multiple>

    <button class="primary" onclick="submitTask()">Submit Task</button>
    <div class="status" id="taskStatus"></div>
  </div>

  <!-- PURCHASE -->
  <div class="card hidden" id="purchaseBox">
    <b>üí≥ Select Payment Method</b>

    <select id="payMethod" onchange="updatePaymentAddress()">
      <option value="">Select method</option>
      <option value="bank">Bank Transfer</option>
      <option value="bnb">BNB Smart Chain (BEP20)</option>
    </select>

    <div id="paymentAddress" class="addressBox hidden"></div>

    <input id="payWhatsapp" placeholder="Your WhatsApp number">
    <input id="payCall" placeholder="Calling number">
    <input type="file" accept="image/*" id="payShot">

    <button class="secondary" onclick="submitPayment()">Submit Payment</button>
    <div class="status" id="payStatus"></div>
  </div>

</div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const BACKEND = "https://promo-oz59.onrender.com";
const user = tg.initDataUnsafe?.user || {};

const telegramId = user.id;
const name = user.first_name || "Guest";
const username = user.username ? "@"+user.username : "No username";

// Show user info
document.getElementById("userInfo").innerHTML = `
<b>Name:</b> ${name}<br>
<b>Username:</b> ${username}<br>
<b>ID:</b> ${telegramId || "Not available"}
`;

// Log for debugging
console.log("User Info:", { telegramId, name, username });
console.log("Backend URL:", BACKEND);

function showTask(){
  taskBox.classList.remove("hidden");
  purchaseBox.classList.add("hidden");
  taskStatus.innerHTML = "";
}

function showPurchase(){
  purchaseBox.classList.remove("hidden");
  taskBox.classList.add("hidden");
  payStatus.innerHTML = "";
}

function updatePaymentAddress(){
  const method = payMethod.value;
  const box = document.getElementById("paymentAddress");

  if(method === "bank"){
    box.innerHTML = `
<b>üè¶ Bank Transfer Details</b><br><br>
<b>Account Name:</b><br>Intel Premium<br><br>
<b>Account Number:</b><br><span id="bankAcc">9114301708</span><br><br>
<b>Bank Name:</b><br>Opay<br><br>
<button class="copy" onclick="copyText('9114301708')">üìã Copy Account Number</button>
    `;
    box.classList.remove("hidden");
  } 
  else if(method === "bnb"){
    box.innerHTML = `
<b>üíé Crypto Payment</b><br><br>
<b>Network:</b><br>BNB Smart Chain (BEP20)<br><br>
<b>Wallet Address:</b><br><span id="bnbAddr">0xbBcc409872bC2441400735624638F3D67DAa7C4C</span><br><br>
<button class="copy" onclick="copyText('0xbBcc409872bC2441400735624638F3D67DAa7C4C')">üìã Copy Wallet Address</button>
<p class="small">‚ö†Ô∏è Send ONLY <b>BNB (BEP20)</b> to this address. Sending other tokens will result in permanent loss.</p>
    `;
    box.classList.remove("hidden");
  } 
  else {
    box.classList.add("hidden");
  }
}

function copyText(text){
  navigator.clipboard.writeText(text).then(()=>{ 
    tg.showAlert("Copied successfully ‚úÖ");
  }).catch(()=>{
    alert("Copied: " + text);
  });
}

async function testConnection(){
  const testStatus = document.getElementById("testStatus");
  testStatus.innerHTML = "‚è≥ Testing connection...";
  
  try {
    // Test root endpoint
    const response = await fetch(BACKEND);
    const data = await response.json();
    
    console.log("Server test response:", data);
    
    if(response.ok){
      testStatus.innerHTML = `‚úÖ Server is running!<br>Status: ${data.status}`;
    } else {
      testStatus.innerHTML = `‚ö†Ô∏è Server responded but with error: ${response.status}`;
    }
    
    // Test health endpoint
    const healthResponse = await fetch(BACKEND + "/health");
    const healthData = await healthResponse.json();
    
    console.log("Health check:", healthData);
    
    testStatus.innerHTML += `<br>Bot Token: ${healthData.botToken}<br>Admin ID: ${healthData.adminId}`;
    
  } catch(err) {
    console.error("Connection test failed:", err);
    testStatus.innerHTML = `‚ùå Cannot connect to server<br>Error: ${err.message}<br><br>Backend URL: ${BACKEND}`;
  }
}

function toBase64(file){
  return new Promise(resolve=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(fr.result);
    fr.readAsDataURL(file);
  });
}

async function submitTask(){
  const files = taskShot.files;
  
  if(!telegramId){
    taskStatus.innerHTML = "‚ùå Telegram ID not found. Please open this from Telegram.";
    return;
  }
  
  if(!files.length){
    taskStatus.innerHTML = "‚ùå Upload at least one screenshot";
    return;
  }
  
  taskStatus.innerHTML = "‚è≥ Sending task...";
  
  try{
    let successCount = 0;
    for(let f of files){
      const image = await toBase64(f);
      const payload = {
        telegramId,
        name,
        username,
        method: "Task",
        whatsapp: taskWhatsapp.value || "N/A",
        call: taskCall.value || "N/A",
        image,
        type: "task"
      };
      
      console.log("Sending task payload:", { ...payload, image: "base64_data_hidden" });
      console.log("Backend URL:", BACKEND+"/unlock-promo");
      
      const response = await fetch(BACKEND+"/unlock-promo", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      
      console.log("Response status:", response.status);
      console.log("Response ok:", response.ok);
      
      const result = await response.json();
      console.log("Server response:", result);
      
      if(response.ok){
        successCount++;
      } else {
        // Show the actual error from server
        const errorMsg = result.details || result.error || "Unknown error";
        throw new Error(errorMsg);
      }
    }
    
    taskStatus.innerHTML = `‚úÖ ${successCount} screenshot(s) sent for review`;
    tg.showAlert("‚úÖ Task submitted successfully!");
    
  }catch(err){
    console.error("Error submitting task:", err);
    taskStatus.innerHTML = "‚ùå Error: " + err.message;
    
    // Show detailed error to user
    const errorDetails = `
Failed to submit task.
Error: ${err.message}

Please check:
1. Server is running
2. Bot token is configured
3. Admin ID is set
4. Internet connection
    `;
    
    tg.showAlert(errorDetails);
  }
}

async function submitPayment(){
  const file = payShot.files[0];
  
  if(!telegramId){
    payStatus.innerHTML = "‚ùå Telegram ID not found. Please open this from Telegram.";
    return;
  }
  
  if(!file || !payMethod.value){
    payStatus.innerHTML = "‚ùå Select method & upload proof";
    return;
  }
  
  payStatus.innerHTML = "‚è≥ Sending payment...";
  
  try{
    const image = await toBase64(file);
    const payload = {
      telegramId,
      name,
      username,
      method: payMethod.value,
      whatsapp: payWhatsapp.value || "N/A",
      call: payCall.value || "N/A",
      image,
      type: "payment"
    };
    
    console.log("Sending payment payload:", { ...payload, image: "base64_data_hidden" });
    
    const response = await fetch(BACKEND+"/unlock-promo", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    
    const result = await response.json();
    console.log("Server response:", result);
    
    if(response.ok){
      payStatus.innerHTML = "‚úÖ Payment sent for review";
      tg.showAlert("‚úÖ Payment submitted successfully!");
    } else {
      throw new Error(result.error || "Failed to send");
    }
    
  }catch(err){
    console.error("Error submitting payment:", err);
    payStatus.innerHTML = "‚ùå Error: " + err.message;
    tg.showAlert("‚ùå Failed to submit. Please try again.");
  }
}
</script>
</body>
</html>
