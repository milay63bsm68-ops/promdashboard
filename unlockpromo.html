<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unlock Promo Earnings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body { background:#020617; color:white; font-family:Arial,sans-serif; padding:20px; }
.container { max-width:480px; margin:auto; }
.card { background:#0f172a; padding:16px; border-radius:14px; margin-bottom:15px; }

button {
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  margin-top:10px;
  cursor:pointer;
}

.primary { background:#22c55e; color:white; }
.secondary { background:#3b82f6; color:white; }
.whatsapp { background:#25D366; color:white; }
.telegram { background:#0088cc; color:white; }
.copy { background:#334155; color:white; font-size:13px; }

input {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  margin-top:10px;
  background:#020617;
  color:white;
}

.status { margin-top:10px; font-size:14px; text-align:center; }
.hidden { display:none; }

.taskSelect {
  display:flex;
  gap:10px;
  margin-top:10px;
}

.taskOption {
  flex:1;
  padding:14px;
  text-align:center;
  border-radius:12px;
  background:#020617;
  cursor:pointer;
  font-weight:bold;
  border:2px solid transparent;
}

.taskOption.active {
  border-color:#22c55e;
  background:#052e16;
}

.addressBox {
  margin-top:12px;
  padding:14px;
  background:#020617;
  border-radius:10px;
  font-size:14px;
}

.amount { color:#22c55e; font-weight:bold; }
.small { font-size:12px; opacity:.85; }
</style>
</head>

<body>
<div class="container">

<div class="card" id="userInfo">Loading user info...</div>

<div class="card">
<b>ğŸ”“ Unlock Promo Earnings</b><br><br>
Choose how you want to unlock ğŸ‘‡
</div>

<div class="card">
<button class="primary" onclick="showTask()">âœ… Complete Simple Task</button>
<p style="text-align:center"><b>OR</b></p>
<button class="secondary" onclick="showPurchase()">ğŸ’³ Purchase Access</button>
<button onclick="location.href='dashboard.html'">ğŸ”™ Back to dashboard</button>
</div>

<!-- TASK -->
<div class="card hidden" id="taskBox">
<b>ğŸ“Œ Task</b><br><br>
1ï¸âƒ£ Join WhatsApp or Telegram group<br>
2ï¸âƒ£ Invite <b>10 people</b><br>
3ï¸âƒ£ Upload <b>screenshots or any proof</b><br><br>

<div class="taskSelect">
  <div id="optTelegram" class="taskOption" onclick="chooseTask('telegram')">
    Telegram Task
  </div>
    <div id="optWhatsapp" class="taskOption" onclick="chooseTask('whatsapp')">
    WhatsApp Task
  </div>
</div>

<hr style="opacity:.2">

<div id="whatsappBox" class="hidden">
  <a href="https://chat.whatsapp.com/BhsFmqjNj49LoaUxrGQuKe" target="_blank">
    <button class="whatsapp">ğŸ“² Join WhatsApp Group</button>
  </a>
  <button class="copy" onclick="copyText('https://chat.whatsapp.com/BhsFmqjNj49LoaUxrGQuKe')">
    ğŸ“‹ Copy WhatsApp Group Link
  </button>
  <input type="tel" id="taskWhatsapp" placeholder="Your WhatsApp number">
</div>

<div id="telegramBox" class="hidden">
  <a href="https://t.me/mayohtech" target="_blank">
    <button class="telegram">ğŸ“² Join Telegram Group</button>
  </a>
  <button class="copy" onclick="copyText('https://t.me/mayohtech')">
    ğŸ“‹ Copy Telegram Group Link
  </button>
  <input id="taskTelegram" placeholder="Your Telegram username or ID">
</div>

<input type="tel" id="taskCall" placeholder="Calling number">
<input type="file" accept="image/*" id="taskShot" multiple>
<button class="primary" onclick="submitTask()">Submit Task</button>
<div class="status" id="taskStatus"></div>
</div>

<!-- PURCHASE -->
<div class="card hidden" id="purchaseBox">
<b>ğŸ’³ Select Payment Method</b>

<select id="payMethod" onchange="updatePaymentAddress()"
style="width:100%;padding:12px;border-radius:10px;background:#020617;color:white;margin-top:10px;">
<option value="">Select method</option>
<option value="bank">Bank Transfer</option>
<option value="bnb">BNB Smart Chain (BEP20)</option>
</select>

<div id="paymentAddress" class="addressBox hidden"></div>

<input type="tel" id="payWhatsapp" placeholder="Your WhatsApp number">
<input type="tel" id="payCall" placeholder="Calling number">
<input type="file" accept="image/*" id="payShot">
<button class="secondary" onclick="submitPayment()">Submit Payment</button>
<div class="status" id="payStatus"></div>
</div>

</div>

<script>
const tg = Telegram.WebApp; tg.ready();
const BACKEND = "https://promo-oz59.onrender.com";

const user = tg.initDataUnsafe?.user || {};
const telegramId = user.id;
const name = user.first_name || "Guest";
const username = user.username ? "@"+user.username : "No username";

userInfo.innerHTML = `<b>Name:</b> ${name}<br><b>Username:</b> ${username}<br><b>ID:</b> ${telegramId||"N/A"}`;

let selectedTask = "";

function showTask(){
  taskBox.classList.remove("hidden");
  purchaseBox.classList.add("hidden");
}

function showPurchase(){
  purchaseBox.classList.remove("hidden");
  taskBox.classList.add("hidden");
}

function chooseTask(type){
  selectedTask = type;

  optWhatsapp.classList.toggle("active", type==="whatsapp");
  optTelegram.classList.toggle("active", type==="telegram");

  whatsappBox.classList.toggle("hidden", type!=="whatsapp");
  telegramBox.classList.toggle("hidden", type!=="telegram");
}

function copyText(text){
  navigator.clipboard.writeText(text);
  tg.showAlert("Copied âœ…");
}

function updatePaymentAddress(){
  if(payMethod.value==="bank"){
    paymentAddress.innerHTML=`<b>ğŸ¦ Bank Transfer</b><br><br>
    <b>ğŸ’° Amount:</b> <span class="amount">â‚¦2,000</span><br><br>
    Account Name: Olatunji Abdulmalik Ayomide<br>
    Account Number: 9114301708<br>
    Bank: Opay<br><br>
    <button class="copy" onclick="copyText('9114301708')">ğŸ“‹ Copy Account Number</button>`;
    paymentAddress.classList.remove("hidden");
  } else if(payMethod.value==="bnb"){
    paymentAddress.innerHTML=`<b>ğŸ’ BNB (BEP20)</b><br><br>
    <b>ğŸ’° Amount:</b> <span class="amount">$4.5</span><br><br>
    Wallet Address: 0xbBcc409872bC2441400735624638F3D67DAa7C4C<br><br>
    <button class="copy" onclick="copyText('0xbBcc409872bC2441400735624638F3D67DAa7C4C')">ğŸ“‹ Copy BNB Address</button>`;
    paymentAddress.classList.remove("hidden");
  } else {
    paymentAddress.classList.add("hidden");
  }
}

// ====== UPDATED TASK SUBMISSION ======
async function submitTask(){
  if(!selectedTask) return taskStatus.innerHTML="âŒ Select a task option";
  if(!taskShot.files.length) return taskStatus.innerHTML="âŒ Upload proof";

  taskStatus.innerHTML="â³ Sending...";

  try {
    for(const f of taskShot.files){
      const reader = new FileReader();
      const fileData = await new Promise((resolve, reject)=>{
        reader.onload = ()=>resolve(reader.result);
        reader.onerror = ()=>reject("Failed to read file");
        reader.readAsDataURL(f);
      });

      const res = await fetch(BACKEND+"/unlock-promo",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          telegramId,name,username,
          method:"Task",
          whatsapp:selectedTask==="whatsapp"?taskWhatsapp.value:"N/A",
          telegramTask:selectedTask==="telegram"?taskTelegram.value:"N/A",
          call:taskCall.value||"N/A",
          image:fileData,
          type:"task"
        })
      });

      const result = await res.json();
      if(!result.success) throw new Error(result.error || "Server rejected submission");
    }

    taskStatus.innerHTML="âœ… Task successfully submitted!";
  } catch(err){
    console.error(err);
    taskStatus.innerHTML=`âŒ Submission failed: ${err.message}`;
  }
}

// ====== UPDATED PAYMENT SUBMISSION ======
async function submitPayment(){
  if(!payShot.files[0]) return payStatus.innerHTML="âŒ Upload receipt";

  payStatus.innerHTML="â³ Sending...";
  const reader = new FileReader();

  try {
    const fileData = await new Promise((resolve,reject)=>{
      reader.onload = ()=>resolve(reader.result);
      reader.onerror = ()=>reject("Failed to read file");
      reader.readAsDataURL(payShot.files[0]);
    });

    const res = await fetch(BACKEND+"/unlock-promo",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        telegramId,name,username,
        method:payMethod.value,
        whatsapp:payWhatsapp.value||"N/A",
        call:payCall.value||"N/A",
        image:fileData,
        type:"payment"
      })
    });

    const result = await res.json();
    if(!result.success) throw new Error(result.error || "Server rejected submission");

    payStatus.innerHTML="âœ… Payment successfully sent!";
  } catch(err){
    console.error(err);
    payStatus.innerHTML=`âŒ Submission failed: ${err.message}`;
  }
}
</script>
</body>
</html>