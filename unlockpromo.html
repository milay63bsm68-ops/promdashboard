<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unlock Promo Earnings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  background:#020617;
  color:white;
  font-family:Arial, sans-serif;
  padding:20px;
}
.container {
  max-width:480px;
  margin:auto;
}
.card {
  background:#0f172a;
  padding:16px;
  border-radius:14px;
  margin-bottom:15px;
}
button {
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  margin-top:10px;
  cursor:pointer;
}
.primary { background:#22c55e; color:white; }
.secondary { background:#3b82f6; color:white; }
input, select {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  margin-top:10px;
  background:#020617;
  color:white;
}
.status {
  margin-top:10px;
  font-size:14px;
  text-align:center;
}
.hidden { display:none; }
</style>
</head>

<body>
<div class="container">

  <div class="card" id="userInfo">Loading user info...</div>

  <div class="card">
    <b>üîì Unlock Promo Earnings</b><br><br>
    Choose how you want to unlock üëá
  </div>

  <div class="card">
    <button class="primary" onclick="showTask()">‚úÖ Complete Simple Task</button>
    <button class="secondary" onclick="showPurchase()">üí≥ Purchase Access</button>
  </div>

  <!-- TASK -->
  <div class="card hidden" id="taskBox">
    <b>üìå Task</b><br><br>
    Join WhatsApp group & invite <b>10 people</b>
    <input id="taskWhatsapp" placeholder="WhatsApp number">
    <input id="taskCall" placeholder="Calling number">
    <input type="file" accept="image/*" id="taskShot" multiple>
    <button class="primary" onclick="submitTask()">Submit Task</button>
    <div class="status" id="taskStatus"></div>
  </div>

  <!-- PURCHASE -->
  <div class="card hidden" id="purchaseBox">
    <b>üè¶ Bank:</b> 9114301708 (Opay)<br>
    <b>üí∞ BNB (BEP20):</b><br>
    <small>0xbBcc409872bC2441400735624638F3D67DAa7C4C</small>

    <input id="payWhatsapp" placeholder="WhatsApp number">
    <input id="payCall" placeholder="Calling number">

    <select id="payMethod">
      <option value="">Select method</option>
      <option>Bank Transfer</option>
      <option>BNB (BEP20)</option>
    </select>

    <input type="file" accept="image/*" id="payShot">
    <button class="secondary" onclick="submitPayment()">Submit Payment</button>
    <div class="status" id="payStatus"></div>
  </div>

</div>

<script>
const tg = Telegram.WebApp;
tg.ready();

/* üîó BACKEND (UNLOCKPROMO ROUTE) */
const BACKEND = "https://promdashboard.onrender.com/unlockpromo";

const user = tg.initDataUnsafe?.user || {};
const telegramId = user.id;
const name = user.first_name || "Guest";
const username = user.username ? "@" + user.username : "No username";

/* ELEMENTS */
const userInfo = document.getElementById("userInfo");
const taskBox = document.getElementById("taskBox");
const purchaseBox = document.getElementById("purchaseBox");
const taskStatus = document.getElementById("taskStatus");
const payStatus = document.getElementById("payStatus");

const taskWhatsapp = document.getElementById("taskWhatsapp");
const taskCall = document.getElementById("taskCall");

const payWhatsapp = document.getElementById("payWhatsapp");
const payCall = document.getElementById("payCall");
const payMethod = document.getElementById("payMethod");

/* USER INFO */
userInfo.innerHTML = `
<b>Name:</b> ${name}<br>
<b>Username:</b> ${username}<br>
<b>ID:</b> ${telegramId}
`;

/* UI SWITCH */
function showTask(){
  taskBox.classList.remove("hidden");
  purchaseBox.classList.add("hidden");
  taskStatus.innerHTML = "";
}

function showPurchase(){
  purchaseBox.classList.remove("hidden");
  taskBox.classList.add("hidden");
  payStatus.innerHTML = "";
}

/* BASE64 */
function toBase64(file){
  return new Promise(resolve=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.readAsDataURL(file);
  });
}

/* SUBMIT TASK */
async function submitTask(){
  const files = document.getElementById("taskShot").files;

  if(!files.length){
    taskStatus.innerHTML = "‚ùå Upload at least one screenshot";
    return;
  }

  taskStatus.innerHTML = "‚è≥ Sending task...";

  try{
    for(const f of files){
      const image = await toBase64(f);
      const message = `üü¢ PROMO TASK SUBMISSION
Name: ${name}
Username: ${username}
ID: ${telegramId}
WhatsApp: ${taskWhatsapp.value}
Call: ${taskCall.value}`;

      await fetch(BACKEND + "/submit", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message, image, telegramId })
      });
    }

    taskStatus.innerHTML = "‚úÖ Task sent for review";
    setTimeout(() => tg.close(), 1200);

  }catch(err){
    console.error(err);
    taskStatus.innerHTML = "‚ùå Error sending task";
  }
}

/* SUBMIT PAYMENT */
async function submitPayment(){
  const file = document.getElementById("payShot").files[0];

  if(!file){
    payStatus.innerHTML = "‚ùå Upload payment proof";
    return;
  }

  if(!payMethod.value){
    payStatus.innerHTML = "‚ùå Select payment method";
    return;
  }

  payStatus.innerHTML = "‚è≥ Sending payment...";

  try{
    const image = await toBase64(file);
    const message = `üü° PROMO PAYMENT
Name: ${name}
Username: ${username}
ID: ${telegramId}
Method: ${payMethod.value}
WhatsApp: ${payWhatsapp.value}
Call: ${payCall.value}`;

    await fetch(BACKEND + "/submit", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ message, image, telegramId })
    });

    payStatus.innerHTML = "‚úÖ Payment sent for confirmation";
    setTimeout(() => tg.close(), 1200);

  }catch(err){
    console.error(err);
    payStatus.innerHTML = "‚ùå Error sending payment";
  }
}
</script>
</body>
</html>