<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unlock Promo Earnings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  background:#020617;
  color:white;
  font-family:Arial, sans-serif;
  padding:20px;
}
.container {
  max-width:480px;
  margin:auto;
}
.card {
  background:#0f172a;
  padding:16px;
  border-radius:14px;
  margin-bottom:15px;
}
button {
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  margin-top:10px;
  cursor:pointer;
}
.primary { background:#22c55e; color:white; }
.secondary { background:#3b82f6; color:white; }
.whatsapp { background:#25D366; color:white; }
.telegram { background:#229ED9; color:white; }
.copy { background:#334155; color:white; font-size:13px; }
input, select {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  margin-top:10px;
  background:#020617;
  color:white;
}
.status {
  margin-top:10px;
  font-size:14px;
  text-align:center;
}
.hidden { display:none; }
</style>
</head>

<body>
<div class="container">

  <div class="card" id="userInfo">Loading user info...</div>

  <div class="card">
    <b>ğŸ”“ Unlock Promo Earnings</b><br><br>
    Choose how you want to unlock ğŸ‘‡
  </div>

  <div class="card">
    <button class="primary" onclick="showTask()">âœ… Complete Simple Task</button>
    <br>     <br>
    <center><b>OR</b></center>
    <button class="secondary" onclick="showPurchase()">ğŸ’³ Purchase Access</button>
    <button onclick="location.href='dashboard.html'">ğŸ”™ Back to dashboard</button>
  </div>

  <!-- TASK -->
  <div class="card hidden" id="taskBox">
    <b>ğŸ“Œ Choose Task Type</b>

    <select id="taskType" onchange="switchTask()">
      <option value="">Select task</option>
      <option value="telegram">Telegram Group Task</option>
      <option value="whatsapp">WhatsApp Group Task</option>
    </select>

    <!-- TELEGRAM TASK -->
    <div id="telegramTask" class="hidden">
      <p>
        1ï¸âƒ£ Join Telegram group<br>
        2ï¸âƒ£ Invite <b>10 people</b><br>
        3ï¸âƒ£ Upload proof
      </p>

      <a href="https://t.me/mayohtech" target="_blank">
        <button class="telegram">ğŸš€ Join Telegram Group</button>
      </a>

      <button class="copy" onclick="copyText('https://t.me/mayohtech')">
        ğŸ“‹ Copy Telegram Group Link
      </button>
    </div>

    <!-- WHATSAPP TASK -->
    <div id="whatsappTask" class="hidden">
      <p>
        1ï¸âƒ£ Join WhatsApp group<br>
        2ï¸âƒ£ Invite <b>10 people</b><br>
        3ï¸âƒ£ Upload proof
      </p>

      <a href="https://chat.whatsapp.com/FVt9vJB1sbJ9q5LTQ0nB3O?mode=gi_t" target="_blank">
        <button class="whatsapp">ğŸ“² Join WhatsApp Group</button>
      </a>

      <button class="copy" onclick="copyText('https://chat.whatsapp.com/FVt9vJB1sbJ9q5LTQ0nB3O?mode=gi_t')">
        ğŸ“‹ Copy WhatsApp Group Link
      </button>
    </div>

    <input id="taskWhatsapp" placeholder="Your WhatsApp number">
    <input id="taskCall" placeholder="Calling number">
    <input type="file" accept="image/*" id="taskShot" multiple>

    <button class="primary" onclick="submitTask()">Submit Task</button>
    <div class="status" id="taskStatus"></div>
  </div>

  <!-- PURCHASE -->
  <div class="card hidden" id="purchaseBox">
    <b>ğŸ’³ Purchase Access</b>
    <!-- unchanged -->
  </div>

</div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const BACKEND = "https://promo-oz59.onrender.com";
const user = tg.initDataUnsafe?.user || {};

const telegramId = user.id;
const name = user.first_name || "Guest";
const username = user.username ? "@"+user.username : "No username";

/* ==== DOM REFERENCES (CRITICAL FIX) ==== */
const userInfo = document.getElementById("userInfo");
const taskBox = document.getElementById("taskBox");
const purchaseBox = document.getElementById("purchaseBox");
const telegramTask = document.getElementById("telegramTask");
const whatsappTask = document.getElementById("whatsappTask");
const taskType = document.getElementById("taskType");
const taskShot = document.getElementById("taskShot");
const taskStatus = document.getElementById("taskStatus");
const taskWhatsapp = document.getElementById("taskWhatsapp");
const taskCall = document.getElementById("taskCall");

/* ==== USER INFO ==== */
userInfo.innerHTML = `
<b>Name:</b> ${name}<br>
<b>Username:</b> ${username}<br>
<b>ID:</b> ${telegramId || "N/A"}
`;

function showTask(){
  taskBox.classList.remove("hidden");
  purchaseBox.classList.add("hidden");
}

function showPurchase(){
  purchaseBox.classList.remove("hidden");
  taskBox.classList.add("hidden");
}

function switchTask(){
  telegramTask.classList.add("hidden");
  whatsappTask.classList.add("hidden");
  taskStatus.innerHTML = "";

  if(taskType.value === "telegram"){
    telegramTask.classList.remove("hidden");
  }
  if(taskType.value === "whatsapp"){
    whatsappTask.classList.remove("hidden");
  }
}

function copyText(text){
  navigator.clipboard.writeText(text);
  tg.showAlert("Copied âœ…");
}

/* ==== BASE64 CONVERTER ==== */
function toBase64(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function submitTask(){
  if(!telegramId) return taskStatus.innerHTML = "âŒ Open inside Telegram";
  if(!taskType.value) return taskStatus.innerHTML = "âŒ Select a task type";
  if(!taskShot.files.length) return taskStatus.innerHTML = "âŒ Upload proof";

  taskStatus.innerHTML = "â³ Sending...";

  try{
    for(const file of taskShot.files){
      const image = await toBase64(file);

      await fetch(BACKEND + "/unlock-promo",{
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          telegramId,
          name,
          username,
          taskType: taskType.value,
          whatsapp: taskWhatsapp.value || "N/A",
          call: taskCall.value || "N/A",
          image,
          type: "task"
        })
      });
    }

    taskStatus.innerHTML = "âœ… Task submitted";
    tg.showAlert("Task submitted âœ…");

  }catch(err){
    taskStatus.innerHTML = "âŒ Failed to submit task";
  }
}
</script>
</body>
</html>