<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>User Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://milay63bsm68-ops.github.io/repro/promolist.js"></script>

<style>
body {
  background:#020617;
  color:white;
  font-family:Arial,sans-serif;
  padding:20px;
  margin:0;
}
.container {
  max-width:480px;
  margin:30px auto 0 auto;
}
.card {
  background:#0f172a;
  padding:16px;
  border-radius:14px;
  margin-bottom:15px;
}
button {
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}
.withdraw { background:#3b82f6; color:white; }
.unlock { background:#22c55e; color:white; }
.copy { background:#1e40af; color:white; }
.tools { background:#f59e0b; color:white; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
}
th, td {
  border:1px solid #1e293b;
  padding:8px;
  text-align:center;
}
th {
  background:#020617;
}
small {
  color:#94a3b8;
}
a {
  color:#3b82f6;
  text-decoration:underline;
}

/* Promo code & link display box */
.promo-box {
  display:flex;
  align-items:center;
  background:#0a1628;
  border:1px solid #1e3a5f;
  border-radius:10px;
  padding:10px 14px;
  margin:6px 0;
  gap:10px;
  word-break:break-all;
}
.promo-box .promo-label {
  font-size:11px;
  color:#64748b;
  margin-bottom:2px;
}
.promo-box .promo-value {
  font-size:14px;
  color:#60a5fa;
  font-family:monospace;
  user-select:all;
  cursor:text;
  flex:1;
}
.promo-icon {
  font-size:20px;
  flex-shrink:0;
}

/* Locked promo notice */
.locked-notice {
  background:linear-gradient(135deg,#1a1a2e,#16213e);
  border:1px dashed #f59e0b;
  border-radius:12px;
  padding:16px;
  text-align:center;
  margin-bottom:10px;
}
.locked-notice .lock-icon {
  font-size:36px;
  margin-bottom:8px;
}
.locked-notice p {
  color:#cbd5e1;
  font-size:14px;
  line-height:1.6;
  margin:0 0 4px 0;
}
.locked-notice strong {
  color:#f59e0b;
}
</style>
</head>

<body>

<div class="container">

  <div class="card" id="user"></div>
  <div class="card" id="balance">Loading balance...</div>
  <div class="card" id="promo"></div>

  <div class="card" id="actionCard">
    <!-- This will be swapped dynamically -->
  </div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe?.user;
const telegramId = user ? String(user.id) : null;
const name = user?.first_name || "Guest";
const username = user?.username ? "@" + user.username : "No username";

document.getElementById("user").innerHTML = `
<b>Name:</b> ${name}<br>
<b>Username:</b> ${username}<br>
<b>Telegram ID:</b> ${telegramId || "N/A"}
`;

// ---------------------------
// Fetch user balance from server
// ---------------------------
async function getUserBalance() {
  if (!telegramId) return 0;
  try {
    const res = await fetch("https://promdashboard.onrender.com/get-balance", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ telegramId })
    });
    const data = await res.json();
    return data?.ngn || 0;
  } catch {
    return 0;
  }
}

async function fetchUsdRate() {
  try {
    const res = await fetch("https://api.exchangerate-api.com/v4/latest/NGN");
    const data = await res.json();
    return data.rates.USD || 0.0026;
  } catch {
    return 0.0026;
  }
}

async function loadBalance() {
  const ngn = await getUserBalance();
  const usdRate = await fetchUsdRate();

  document.getElementById("balance").innerHTML = `
    <b>Balance</b><br>
    ‚Ç¶${ngn.toLocaleString()} ‚âà $${(ngn * usdRate).toFixed(2)}
  `;

  document.getElementById("actionCard").innerHTML = `
    <!-- Swapped: All Tools button replaces Withdraw position -->
    <button class="tools" onclick="window.open('https://t.me/intelligentverificationlinkbot','_blank')">
      üõ†Ô∏è Al h√¶√ßking tools & Links
    </button>

    <!-- Earnings description -->
    <div id="earnings" style="margin-top:18px;"></div>
  `;

  document.getElementById("earnings").innerHTML = `
    <b>üí∞ How Promo Earnings Work</b><br><br>
    When someone buys any premium plan using <b>your personal promo code</b>,
    you instantly earn commission as shown below üëá
    <br><br>

    <table>
      <tr>
        <th>Premium Plan</th>
        <th>User Pays</th>
        <th>You Earn</th>
      </tr>
      <tr>
        <td>7 Days</td>
        <td>‚Ç¶3,500</td>
        <td>‚Ç¶1,000 ‚âà $${(1000 * usdRate).toFixed(2)}</td>
      </tr>
      <tr>
        <td>14 Days</td>
        <td>‚Ç¶7,000</td>
        <td>‚Ç¶2,000 ‚âà $${(2000 * usdRate).toFixed(2)}</td>
      </tr>
      <tr>
        <td>Forever</td>
        <td>‚Ç¶20,000</td>
        <td>‚Ç¶5,000 ‚âà $${(5000 * usdRate).toFixed(2)}</td>
      </tr>
    </table>

    <br>
    <small>
      üìå Share your promo link anywhere.  
      Every successful purchase adds earnings to your balance.
    </small>
  `;
}
loadBalance();

// ---------------------------
// Promo code logic
// ---------------------------
function checkPromo() {
  const promoContainer = document.getElementById("promo");
  if (!Array.isArray(PROMO_LIST) || !telegramId) return;

  const hasPromo = PROMO_LIST.includes(telegramId);

  // Swap: Withdraw button replaces All Tools position in promo card
  let content = `
    <button class="withdraw" onclick="window.open('https://t.me/intelpremiumbot/withdraw','_blank')">
      üí∏ Withdraw
    </button><br><br>
  `;

  if (hasPromo) {
    const promoCode = telegramId;
    const promoLink = `https://intelligentverificationlink.ct.ws?ref=${telegramId}`;

    content += `
      <b>üéØ Promo Access:</b> Enabled ‚úÖ<br><br>

      <div class="promo-box">
        <span class="promo-icon">üè∑Ô∏è</span>
        <div style="flex:1;">
          <div class="promo-label">Your Promo Code</div>
          <div class="promo-value" id="promoCodeText">${promoCode}</div>
        </div>
      </div>

      <button class="copy" onclick="copyText('${promoCode}', 'Promo code')">
        üìã Copy Promo Code
      </button>

      <div class="promo-box" style="margin-top:12px;">
        <span class="promo-icon">üîó</span>
        <div style="flex:1;">
          <div class="promo-label">Your Promo Link</div>
          <div class="promo-value" id="promoLinkText"><a href="${promoLink}" target="_blank">${promoLink}</a></div>
        </div>
      </div>

      <button class="copy" onclick="copyText('${promoLink}', 'Promo link')">
        üîó Copy Promo Link
      </button>

      <br><br>
      <small>Your promo code is your Telegram ID</small>
    `;
  } else {
    content += `
      <div class="locked-notice">
        <div class="lock-icon">üîí</div>
        <p><strong>Promo Earning Access Not Unlocked Yet</strong></p>
        <p>
          You have not unlocked promo earnings access.<br>
          Click the button below to get started and start earning
          real money with your personal promo code!
        </p>
      </div>

      <button class="unlock" onclick="location.href='unlockpromo.html'">
        üîì Unlock Promo Earnings
      </button>
    `;
  }

  promoContainer.innerHTML = content;
}

function copyText(text, label) {
  navigator.clipboard.writeText(text);
  alert((label || "Text") + " copied successfully!");
}

function waitForPromoList() {
  if (typeof PROMO_LIST !== 'undefined') {
    checkPromo();
  } else {
    setTimeout(waitForPromoList, 50);
  }
}
waitForPromoList();
</script>

</body>
</html>
