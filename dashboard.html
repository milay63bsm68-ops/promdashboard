<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>User Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="balance.js"></script>
<script src="https://milay63bsm68-ops.github.io/repro/promolist.js"></script>

<style>
body {
  background:#020617;
  color:white;
  font-family:Arial, sans-serif;
  padding:20px;
  margin:0;
}
.container {
  max-width:480px;
  margin:30px auto 0 auto;
}
.card {
  background:#0f172a;
  padding:16px;
  border-radius:14px;
  margin-bottom:15px;
}
button {
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}
.withdraw { background:#3b82f6; color:white; }
.unlock { background:#22c55e; color:white; }

.promo-link { 
  background:#1e40af; 
  color:white; 
  padding:10px; 
  border-radius:10px; 
  word-break: break-all;
  text-align:center;
  margin-top:10px;
  cursor:pointer;
}

input {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  outline:none;
  margin-top:10px;
  background:#020617;
  color:white;
  text-align:center;
}
small { color:#94a3b8; }
</style>
</head>

<body>

<div class="container">

  <div class="card" id="user"></div>
  <div class="card" id="balance">Loading balance...</div>
  <div class="card" id="promo"></div>

  <div class="card">
    <button class="withdraw" onclick="location.href='withdraw.html'">
      ðŸ’¸ Withdraw
    </button>

    <!-- Earnings description -->
    <div id="earnings" style="margin-top:15px;font-size:14px;"></div>
  </div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe?.user;
const telegramId = user ? String(user.id) : null;
const name = user?.first_name || "Guest";
const username = user?.username ? "@" + user.username : "No username";

document.getElementById("user").innerHTML = `
<b>Name:</b> ${name}<br>
<b>Username:</b> ${username}<br>
<b>Telegram ID:</b> ${telegramId || "N/A"}
`;

function getUserBalance() {
  if (!window.USER_BALANCES) return 0;
  if (!telegramId || !window.USER_BALANCES[telegramId]) return 0;
  return window.USER_BALANCES[telegramId].ngn || 0;
}

async function fetchUsdRate() {
  try {
    const res = await fetch("https://api.exchangerate-api.com/v4/latest/NGN");
    const data = await res.json();
    return data.rates.USD || 0.0026;
  } catch {
    return 0.0026;
  }
}

async function loadBalance() {
  const ngn = getUserBalance();
  const usdRate = await fetchUsdRate();
  const usd = ngn * usdRate;

  document.getElementById("balance").innerHTML = `
    <b>Balance</b><br>
    â‚¦${ngn.toLocaleString()} â‰ˆ $${usd.toFixed(2)}
  `;

  // Earnings table
  document.getElementById("earnings").innerHTML = `
    <b>ðŸ’° Promo Earnings</b><br><br>
    7 Days Plan (â‚¦3,500) â†’ <b>â‚¦1,000</b> â‰ˆ <b>$${(1000*usdRate).toFixed(2)}</b><br>
    14 Days Plan (â‚¦7,000) â†’ <b>â‚¦2,000</b> â‰ˆ <b>$${(2000*usdRate).toFixed(2)}</b><br>
    Forever Plan (â‚¦20,000) â†’ <b>â‚¦5,000</b> â‰ˆ <b>$${(5000*usdRate).toFixed(2)}</b>
  `;
}
loadBalance();

function checkPromo() {
  const promoContainer = document.getElementById("promo");
  if (!Array.isArray(PROMO_LIST) || !telegramId) {
    promoContainer.innerHTML = '';
    return;
  }

  const hasPromo = PROMO_LIST.includes(telegramId);

  if (hasPromo) {
    promoContainer.innerHTML = `
      <b>Promo Access:</b> âœ… Enabled

      <input id="promoCode" placeholder="Enter Telegram ID (numbers only)" oninput="this.value=this.value.replace(/\\D/g,'')">

      <div class="promo-link" onclick="copyPromo()">
        ðŸ”— Generate Promo Link
      </div>

      <small>Promo code must be a Telegram ID only</small>
    `;
  } else {
    promoContainer.innerHTML = `
      <button class="unlock" onclick="location.href='unlockpromo.html'">
        ðŸ”“ Unlock Promo Earnings
      </button>
    `;
  }
}

function copyPromo() {
  const code = document.getElementById("promoCode").value;
  if (!code) {
    alert("Please enter a Telegram ID");
    return;
  }
  const link = `https://yourwebsite.com/signup?ref=${code}`;
  navigator.clipboard.writeText(link);
  alert("Promo link copied!");
}

function waitForPromoList() {
  if (typeof PROMO_LIST !== 'undefined') {
    checkPromo();
  } else {
    setTimeout(waitForPromoList, 50);
  }
}
waitForPromoList();
</script>

</body>
</html>