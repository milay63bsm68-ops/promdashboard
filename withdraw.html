<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Withdraw</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }
body {
  background:#020617;
  color:white;
  font-family:Arial, sans-serif;
  padding:14px;
  margin:0;
  overflow-x:hidden;
}
.container { max-width:420px; margin:0 auto; }
.card {
  background:#0f172a;
  padding:14px;
  border-radius:14px;
  margin-bottom:12px;
}
h3 { margin:0 0 8px 0; font-size:14px; font-weight:bold; }
input, select {
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:10px;
  border:none;
  background:#020617;
  color:white;
  font-size:14px;
  height: 50px;
}
button {
  width:100%;
  padding:12px;
  margin-top:12px;
  border:none;
  border-radius:12px;
  background:#3b82f6;
  color:white;
  font-weight:bold;
  font-size:14px;
}
button:disabled { opacity:0.5; }
.msg { margin-top:10px; padding:8px; border-radius:8px; font-size:13px; }
.error { background:#ef4444; }
.success { background:#22c55e; }
.loading { background:#facc15; color:black; }
.small { font-size:12px; opacity:0.75; }
.small2 { font-size:20px; opacity:0.75; }
.hidden { display:none; }
</style>
</head>

<body>

<div class="container">

  <!-- USER INFO -->
  <div class="card" id="userInfo">Loading user…</div>

  <!-- BALANCE -->
  <div class="card" id="balanceBox">Loading balance…</div>

  <!-- MESSAGE FOR LOW BALANCE -->
  <div class="card hidden" id="lowBalanceMsg">
    <div class="msg error">
      Minimum balance required to withdraw:<br>
      ₦5,000 for bank transfer<br>
      $20 for crypto
    </div>
   <button onclick="window.location.href='https://t.me/intelpremiumbot/premiumdash'">Go Back</button>
  </div>

  <!-- WITHDRAW FORM -->
  <div class="card hidden" id="withdrawForm">

    <h3>Withdrawal Method</h3>
    <select id="method">
      <option value="">Select method</option>
      <option value="bank">Bank Transfer (₦)</option>
      <option value="crypto">Crypto (BNB BEP20)</option>
    </select>

    <!-- BANK -->
    <div id="bankFields" class="hidden">
      <h3 style="margin-top:10px">Bank Details</h3>
      <select id="bank">
        <option value="">Select Bank</option>
        <option>Opay</option>
        <option>PalmPay</option>
        <option>Moniepoint</option>
        <option>GTBank</option>
        <option>Access Bank</option>
        <option>Zenith Bank</option>
        <option>UBA</option>
        <option>First Bank</option>
        <option>FCMB</option>
        <option>Other</option>
      </select>
      <input id="otherBank" placeholder="Other bank name" class="hidden">
      <input id="acctName" placeholder="Account Name">
      <input type="number" id="acctNumber" placeholder="Account Number">
      <input id="bankAmount" type="number" placeholder="Amount (₦)">
      <div class="small">Minimum: ₦5,000</div>
    </div>

    <!-- CRYPTO -->
    <div id="cryptoFields" class="hidden">
      <h3 style="margin-top:10px">Crypto Details</h3>
      <input id="wallet" placeholder="BNB Smart Chain (BEP20) Address">
      <input id="cryptoAmount" type="number" placeholder="Amount ($)">
      <div class="small">Minimum: $20</div>
    </div>

    <!-- CONTACT -->
    <h3 style="margin-top:10px">Contact Details</h3>
    <input type="tel" id="whatsapp" placeholder="WhatsApp Number">
    <input type="tel" id="phone" placeholder="Calling Number">

    <!-- PASSCODE -->
    <button id="generatePasscodeBtn">Generate Withdrawal Passcode</button>
    <div id="passcodeContainer" class="hidden">
      <input id="passcode" placeholder="Enter passcode">
      <div class="small2">
        Check your Telegram bot for the code: 
        <a href="https://t.me/intelpremiumbot" target="_blank">@intelpremiumbot</a>
      </div>
    </div>

    <button id="withdrawBtn" disabled>Submit Withdrawal</button>
    <div id="msgBox"></div>
  </div>

</div>

<script>
const API = "/withdraw";
const tg = window.Telegram?.WebApp;
tg?.ready();

const user = tg?.initDataUnsafe?.user;
const telegramId = user ? String(user.id) : null;

const userInfo = document.getElementById("userInfo");
const balanceBox = document.getElementById("balanceBox");
const msgBox = document.getElementById("msgBox");
const withdrawBtn = document.getElementById("withdrawBtn");
const withdrawForm = document.getElementById("withdrawForm");
const lowBalanceMsg = document.getElementById("lowBalanceMsg");
const generatePasscodeBtn = document.getElementById("generatePasscodeBtn");
const passcodeContainer = document.getElementById("passcodeContainer");
const passcodeInput = document.getElementById("passcode");

if(!telegramId){
  userInfo.innerHTML = "❌ Please open this page from the Telegram WebApp.";
}

let balanceNGN = 0;
let ngnPerUsd = 1600; // NGN per $1, updated from server

// Show user info
if(telegramId){
  userInfo.innerHTML = `
  <b>Name:</b> ${user?.first_name || "N/A"}<br>
  <b>Username:</b> ${user?.username ? "@"+user.username : "N/A"}<br>
  <b>ID:</b> ${telegramId}
  `;
}

function showMsg(text, type="success"){
  msgBox.innerHTML = text ? `<div class="msg ${type}">${text}</div>` : "";
}

// Load balance from server (server also returns ngnPerUsd)
async function loadBalance(){
  if(!telegramId) return;
  showMsg("Loading balance…", "loading");
  try {
    const r = await fetch("/get-balance", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ telegramId })
    });
    const d = await r.json();
    balanceNGN = d?.ngn || 0;

    // Use rate from server (same rate used server-side), fallback to 1600
    if(d?.usdRate && d.usdRate > 100){
      ngnPerUsd = d.usdRate;
    }

    const balanceUsd = balanceNGN / ngnPerUsd;

    balanceBox.innerHTML = `<b>Balance:</b><br>₦${balanceNGN.toLocaleString()} ≈ $${balanceUsd.toFixed(2)}`;

    // Show low balance warning only if user can't meet EITHER minimum
    const canBank = balanceNGN >= 5000;
    const canCrypto = balanceUsd >= 20;

    if(!canBank && !canCrypto){
      lowBalanceMsg.classList.remove("hidden");
      withdrawForm.classList.add("hidden");
    } else {
      withdrawForm.classList.remove("hidden");
      lowBalanceMsg.classList.add("hidden");
      withdrawBtn.disabled = true; // wait for passcode
    }
    showMsg("");
  } catch(err){
    showMsg("Failed to load balance: "+err.message, "error");
    withdrawForm.classList.add("hidden");
    lowBalanceMsg.classList.add("hidden");
  }
}
loadBalance();

// Show/hide fields
method.onchange = () => {
  bankFields.style.display = method.value==="bank" ? "block" : "none";
  cryptoFields.style.display = method.value==="crypto" ? "block" : "none";
};
bank.onchange = () => {
  otherBank.style.display = bank.value==="Other" ? "block" : "none";
};

// Generate passcode
generatePasscodeBtn.onclick = async () => {
  if(!telegramId) return;
  showMsg("Generating passcode…","loading");
  generatePasscodeBtn.disabled = true;
  try{
    const res = await fetch("/generate-passcode", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ telegramId })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || "Failed to generate passcode");
    showMsg("✅ Passcode sent to your Telegram. Enter it below.", "success");
    passcodeContainer.classList.remove("hidden");
    withdrawBtn.disabled = false;
  } catch(err){
    showMsg("❌ "+err.message, "error");
    generatePasscodeBtn.disabled = false;
  }
};

// Withdraw
withdrawBtn.onclick = async () => {
  if(!telegramId) return;
  const methodVal = method.value;
  if(!methodVal) return showMsg("Select withdrawal method", "error");

  const passcodeVal = passcodeInput.value.trim();
  if(!passcodeVal) return showMsg("Enter your passcode", "error");

  // amountNGN is always sent to server in NGN
  let amountNGN = 0;

  if(methodVal === "bank"){
    amountNGN = Number(bankAmount.value);
    if(!amountNGN || amountNGN <= 0) return showMsg("Enter a valid amount", "error");
    if(amountNGN < 5000) return showMsg("Minimum bank withdrawal is ₦5,000", "error");
    if(amountNGN > balanceNGN) return showMsg("Insufficient balance", "error");
  }

  if(methodVal === "crypto"){
    const usd = Number(cryptoAmount.value);
    if(!usd || usd <= 0) return showMsg("Enter a valid amount", "error");
    if(usd < 20) return showMsg("Minimum crypto withdrawal is $20", "error");

    // Convert USD → NGN: multiply by how many naira per dollar
    amountNGN = Math.round(usd * ngnPerUsd);

    if(amountNGN > balanceNGN){
      const availableUsd = (balanceNGN / ngnPerUsd).toFixed(2);
      return showMsg(`Insufficient balance. You can withdraw up to $${availableUsd}`, "error");
    }
  }

  showMsg("Submitting withdrawal…", "loading");
  withdrawBtn.disabled = true;

  try{
    const res = await fetch(API, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        telegramId,
        method: methodVal,
        amount: amountNGN, // always NGN
        passcode: passcodeVal,
        details:{
          bank: bank.value==="Other" ? otherBank.value : bank.value,
          accountName: acctName.value,
          accountNumber: acctNumber.value,
          wallet: wallet.value,
          whatsapp: whatsapp.value,
          phone: phone.value
        }
      })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || "Withdrawal failed");

    showMsg("✅ Withdrawal submitted successfully!", "success");
    balanceNGN = data.newBalance;
    balanceBox.innerHTML = `<b>Balance:</b><br>₦${balanceNGN.toLocaleString()} ≈ $${(balanceNGN / ngnPerUsd).toFixed(2)}`;
    withdrawBtn.disabled = true;
  } catch(err){
    showMsg("❌ Withdrawal failed: "+err.message, "error");
    withdrawBtn.disabled = false;
  }
};
</script>

</body>
</html>
