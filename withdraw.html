<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Withdraw</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* {
  box-sizing: border-box;
}

body {
  background:#020617;
  color:white;
  font-family:Arial, sans-serif;
  padding:14px;
  margin:0;
  overflow-x:hidden;
}

.container {
  max-width:420px;
  margin:0 auto;
}

.card {
  background:#0f172a;
  padding:12px;
  border-radius:14px;
  margin-bottom:12px;
}

h3 {
  margin:0 0 8px 0;
  font-size:14px;
  font-weight:bold;
}

label {
  font-size:13px;
  opacity:0.9;
}

input, select {
  width:100%;
  padding:9px;
  margin-top:6px;
  border-radius:10px;
  border:none;
  background:#020617;
  color:white;
  font-size:14px;
}

button {
  width:100%;
  padding:11px;
  margin-top:12px;
  border:none;
  border-radius:12px;
  background:#3b82f6;
  color:white;
  font-weight:bold;
  font-size:14px;
}

button:disabled {
  opacity:0.5;
}

.msg {
  margin-top:10px;
  padding:8px;
  border-radius:8px;
  font-size:13px;
}

.error { background:#ef4444; }
.success { background:#22c55e; }
.loading { background:#facc15; color:black; }

.small {
  font-size:12px;
  opacity:0.75;
}
</style>
</head>

<body>

<div class="container">

  <!-- USER INFO -->
  <div class="card" id="userInfo">Loading user…</div>

  <!-- BALANCE -->
  <div class="card" id="balanceBox">Loading balance…</div>

  <!-- WITHDRAW FORM -->
  <div class="card">

    <h3>Withdrawal Method</h3>
    <select id="method">
      <option value="">Select method</option>
      <option value="bank">Bank Transfer (₦)</option>
      <option value="crypto">Crypto (BNB BEP20)</option>
    </select>

    <!-- BANK -->
    <div id="bankFields" style="display:none">
      <h3 style="margin-top:10px">Bank Details</h3>

      <select id="bank">
        <option value="">Select Bank</option>
        <option>Opay</option>
        <option>PalmPay</option>
        <option>Moniepoint</option>
        <option>GTBank</option>
        <option>Access Bank</option>
        <option>Zenith Bank</option>
        <option>UBA</option>
        <option>First Bank</option>
        <option>FCMB</option>
        <option>Other</option>
      </select>

      <input id="otherBank" placeholder="Other bank name" style="display:none">
      <input id="acctName" placeholder="Account Name">
      <input id="acctNumber" placeholder="Account Number">
      <input id="bankAmount" type="number" placeholder="Amount (₦)">
      <div class="small">Minimum: ₦5,000</div>
    </div>

    <!-- CRYPTO -->
    <div id="cryptoFields" style="display:none">
      <h3 style="margin-top:10px">Crypto Details</h3>

      <input id="wallet" placeholder="BNB Smart Chain (BEP20) Address">
      <input id="cryptoAmount" type="number" placeholder="Amount ($)">
      <div class="small">Minimum: $20</div>
    </div>

    <!-- CONTACT -->
    <h3 style="margin-top:10px">Contact Details</h3>
    <input id="whatsapp" placeholder="WhatsApp Number">
    <input id="phone" placeholder="Calling Number">

    <button id="withdrawBtn" onclick="withdraw()" disabled>
      Submit Withdrawal
    </button>

    <div id="msgBox"></div>
  </div>

</div>

<script>
const API = "https://promdashboard.onrender.com";
const tg = window.Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe?.user;
const telegramId = user ? String(user.id) : null;

const userInfo = document.getElementById("userInfo");
const balanceBox = document.getElementById("balanceBox");
const msgBox = document.getElementById("msgBox");
const withdrawBtn = document.getElementById("withdrawBtn");

let balanceNGN = 0;
let usdRate = 0;

function msg(text, type="success") {
  msgBox.innerHTML = text ? `<div class="msg ${type}">${text}</div>` : "";
}

userInfo.innerHTML = `
<b>Name:</b> ${user?.first_name || "N/A"}<br>
<b>Username:</b> ${user?.username ? "@"+user.username : "N/A"}<br>
<b>ID:</b> ${telegramId || "N/A"}
`;

async function loadBalance() {
  msg("Loading balance…", "loading");

  const r = await fetch(API + "/admin/get-balance", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ telegramId })
  });

  const d = await r.json();
  balanceNGN = d?.ngn || 0;

  const rate = await fetch("https://api.exchangerate.host/convert?from=NGN&to=USD");
  const rd = await rate.json();
  usdRate = rd?.info?.rate || 0.002;

  balanceBox.innerHTML =
    `<b>Balance:</b><br>₦${balanceNGN.toLocaleString()} ≈ $${(balanceNGN*usdRate).toFixed(2)}`;

  withdrawBtn.disabled = balanceNGN < 5000;
  msg("");
}
loadBalance();

method.onchange = () => {
  bankFields.style.display = method.value==="bank" ? "block" : "none";
  cryptoFields.style.display = method.value==="crypto" ? "block" : "none";
};

bank.onchange = () => {
  otherBank.style.display = bank.value==="Other" ? "block" : "none";
};

async function withdraw() {
  const methodVal = method.value;
  if (!methodVal) return msg("Select withdrawal method", "error");

  let amountNGN = 0;

  if (methodVal === "bank") {
    amountNGN = Number(bankAmount.value);
    if (amountNGN < 5000) return msg("Minimum bank withdrawal is ₦5,000", "error");
  }

  if (methodVal === "crypto") {
    const usd = Number(cryptoAmount.value);
    if (usd < 20) return msg("Minimum crypto withdrawal is $20", "error");
    amountNGN = usd / usdRate;
  }

  msg("Submitting withdrawal…", "loading");

  const res = await fetch(API + "/withdraw", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      telegramId,
      method: methodVal,
      amount: Math.round(amountNGN),
      details: {
        bank: bank.value==="Other" ? otherBank.value : bank.value,
        accountName: acctName.value,
        accountNumber: acctNumber.value,
        wallet: wallet.value,
        whatsapp: whatsapp.value,
        phone: phone.value
      }
    })
  });

  const data = await res.json();
  if (!res.ok) return msg(data.error, "error");

  msg("Withdrawal submitted successfully", "success");
  withdrawBtn.disabled = true;
}
</script>

</body>
</html>