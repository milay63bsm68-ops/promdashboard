<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Withdraw Earnings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #050a14;
  --surface: #0b1526;
  --surface2: #111e35;
  --border: #1a2d4d;
  --accent: #00e5a0;
  --accent2: #3b9eff;
  --accent3: #f59e0b;
  --text: #e2eaf6;
  --muted: #4a6080;
  --danger: #ff4d6d;
}
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg); color: var(--text);
  font-family: 'Syne', sans-serif; min-height: 100vh;
  overflow-x: hidden; padding-bottom: 40px;
}
body::before {
  content: ''; position: fixed; top: -200px; right: -200px;
  width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(59,158,255,0.06) 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}
body::after {
  content: ''; position: fixed; bottom: -200px; left: -100px;
  width: 400px; height: 400px;
  background: radial-gradient(circle, rgba(0,229,160,0.05) 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.top-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(5,10,20,0.92); backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 14px 20px; display: flex; align-items: center; gap: 12px;
}
.back-btn {
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--text); border-radius: 10px; padding: 7px 14px;
  font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
}
.back-btn:hover { border-color: var(--accent2); color: var(--accent2); }
.page-title {
  font-size: 16px; font-weight: 800;
  background: linear-gradient(90deg, var(--accent2), var(--accent));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

/* ‚îÄ‚îÄ‚îÄ CONTAINER ‚îÄ‚îÄ‚îÄ */
.container {
  max-width: 480px; margin: 0 auto;
  padding: 20px 16px; position: relative; z-index: 1;
}

/* ‚îÄ‚îÄ‚îÄ PROFILE CARD ‚îÄ‚îÄ‚îÄ */
.profile-card {
  background: linear-gradient(135deg, var(--surface) 0%, #0d1e38 100%);
  border: 1px solid var(--border); border-radius: 18px;
  padding: 16px 18px; margin-bottom: 14px;
  display: flex; align-items: center; gap: 12px;
  position: relative; overflow: hidden;
  animation: fadeUp 0.4s ease;
}
.profile-card::before {
  content: ''; position: absolute; top: 0; right: 0;
  width: 100px; height: 100px;
  background: radial-gradient(circle, rgba(59,158,255,0.08) 0%, transparent 70%);
}
.avatar {
  width: 44px; height: 44px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent2), var(--accent));
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; flex-shrink: 0; border: 2px solid rgba(59,158,255,0.3);
}
.profile-info { flex: 1; }
.profile-name { font-size: 14px; font-weight: 700; }
.profile-meta { font-size: 11px; color: var(--muted); font-family: 'DM Mono', monospace; margin-top: 3px; }

/* ‚îÄ‚îÄ‚îÄ BALANCE CARD ‚îÄ‚îÄ‚îÄ */
.balance-card {
  background: linear-gradient(135deg, #051420 0%, #0a1e38 100%);
  border: 1px solid rgba(59,158,255,0.25); border-radius: 18px;
  padding: 20px; margin-bottom: 14px;
  position: relative; overflow: hidden;
  animation: fadeUp 0.45s ease;
}
.balance-card::before {
  content: ''; position: absolute; top: -20px; right: -20px;
  width: 120px; height: 120px;
  background: radial-gradient(circle, rgba(59,158,255,0.12) 0%, transparent 70%);
}
.balance-label { font-size: 11px; font-weight: 600; letter-spacing: 1.5px; color: var(--accent2); text-transform: uppercase; margin-bottom: 6px; }
.balance-ngn   { font-size: 30px; font-weight: 800; letter-spacing: -0.5px; }
.balance-usd   { font-size: 13px; color: var(--muted); font-family: 'DM Mono', monospace; margin-top: 4px; }
.balance-icon  { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 40px; opacity: 0.2; }

/* ‚îÄ‚îÄ‚îÄ CARD ‚îÄ‚îÄ‚îÄ */
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 18px; padding: 20px; margin-bottom: 14px;
  animation: fadeUp 0.5s ease;
}
.card-title {
  font-size: 15px; font-weight: 700; margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.card-title span { font-size: 18px; }

/* ‚îÄ‚îÄ‚îÄ LOW BALANCE NOTICE ‚îÄ‚îÄ‚îÄ */
.low-notice {
  background: linear-gradient(135deg, rgba(255,77,109,0.06), rgba(255,77,109,0.02));
  border: 1px dashed rgba(255,77,109,0.4); border-radius: 16px;
  padding: 24px; text-align: center; margin-bottom: 14px;
  animation: fadeUp 0.5s ease;
}
.low-notice .icon { font-size: 44px; margin-bottom: 12px; }
.low-notice h3 { font-size: 16px; color: var(--danger); margin-bottom: 8px; }
.low-notice p  { font-size: 13px; color: var(--muted); line-height: 1.8; }

/* ‚îÄ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ‚îÄ */
input, select {
  width: 100%; padding: 13px 14px; margin-top: 10px;
  border-radius: 12px; border: 1px solid var(--border);
  background: var(--surface2); color: var(--text);
  font-family: 'Syne', sans-serif; font-size: 14px;
  outline: none; transition: border-color 0.2s;
}
input:focus, select:focus { border-color: var(--accent2); }
select option { background: #0b1526; }
.field-group { margin-top: 16px; }
.field-label { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; display: block; margin-bottom: 0; }
.field-hint  { font-size: 12px; color: var(--muted); margin-top: 6px; }

/* ‚îÄ‚îÄ‚îÄ PASSCODE SECTION ‚îÄ‚îÄ‚îÄ */
.passcode-section { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
.passcode-note { font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.6; }
.passcode-note a { color: var(--accent2); }

/* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
.btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%; padding: 15px; border: none; border-radius: 14px;
  font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700;
  cursor: pointer; margin-top: 12px; transition: all 0.2s ease;
  letter-spacing: 0.3px;
}
.btn:active { transform: scale(0.97); }
.btn-blue   { background: linear-gradient(135deg, #1e40af, var(--accent2)); color: white; box-shadow: 0 4px 20px rgba(59,158,255,0.25); }
.btn-green  { background: linear-gradient(135deg, #065f46, var(--accent));  color: white; box-shadow: 0 4px 20px rgba(0,229,160,0.2); }
.btn-dark   { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none !important; }
.btn:not(:disabled):hover { filter: brightness(1.1); }

/* ‚îÄ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ‚îÄ */
.msg {
  margin-top: 12px; padding: 13px 16px; border-radius: 12px;
  font-size: 13px; line-height: 1.5; display: none;
}
.msg.show    { display: block; }
.msg.error   { background: rgba(255,77,109,0.1);  border: 1px solid rgba(255,77,109,0.3);  color: var(--danger);  }
.msg.success { background: rgba(0,229,160,0.1);   border: 1px solid rgba(0,229,160,0.3);   color: var(--accent);  }
.msg.loading { background: rgba(245,158,11,0.1);  border: 1px solid rgba(245,158,11,0.3);  color: var(--accent3); }

.hidden { display: none !important; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(14px); }
  to   { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="top-header">
  <button class="back-btn" onclick="location.href='dashboard.html'">‚Üê Back</button>
  <div class="page-title">üí∏ Withdraw Earnings</div>
</div>

<div class="container">

  <!-- PROFILE -->
  <div class="profile-card">
    <div class="avatar">üë§</div>
    <div class="profile-info">
      <div class="profile-name" id="pName">Loading...</div>
      <div class="profile-meta" id="pMeta">‚Äî</div>
    </div>
  </div>

  <!-- BALANCE -->
  <div class="balance-card" id="balanceCard">
    <div class="balance-label">Available Balance</div>
    <div class="balance-ngn" id="balNgn">Loading‚Ä¶</div>
    <div class="balance-usd" id="balUsd"></div>
    <div class="balance-icon">üí∏</div>
  </div>

  <!-- LOW BALANCE (hidden until checked) -->
  <div class="low-notice hidden" id="lowMsg">
    <div class="icon">‚ö†Ô∏è</div>
    <h3>Balance Too Low</h3>
    <p>
      You need at least:<br>
      <strong style="color:var(--text);">‚Ç¶5,000</strong> for bank transfer<br>
      <strong style="color:var(--text);">$20</strong> for crypto withdrawal
    </p>
    <a href="https://intelgroup.onrender.com/deposit.html" target="_blank">
      <button class="btn btn-green" style="margin-top:14px;">üí≥ Make a Deposit</button>
    </a>
  </div>

  <!-- WITHDRAW FORM (hidden until balance loaded) -->
  <div class="card hidden" id="withdrawCard">
    <div class="card-title"><span>üìã</span> Withdrawal Details</div>

    <!-- METHOD -->
    <div class="field-group">
      <span class="field-label">Withdrawal Method</span>
      <select id="method">
        <option value="">-- Select method --</option>
        <option value="bank">üè¶ Bank Transfer (‚Ç¶ Naira)</option>
        <option value="crypto">üíé Crypto ‚Äî BNB BEP20 ($)</option>
      </select>
    </div>

    <!-- BANK FIELDS -->
    <div id="bankFields" class="hidden">
      <div class="field-group">
        <span class="field-label">Bank Name</span>
        <select id="bank">
          <option value="">Select Bank</option>
          <option>Opay</option><option>PalmPay</option><option>Moniepoint</option>
          <option>GTBank</option><option>Access Bank</option><option>Zenith Bank</option>
          <option>UBA</option><option>First Bank</option><option>FCMB</option>
          <option>Other</option>
        </select>
        <input id="otherBank" placeholder="Bank name" class="hidden" style="margin-top:8px;">
      </div>
      <div class="field-group">
        <span class="field-label">Account Name</span>
        <input id="acctName" placeholder="Full account name">
      </div>
      <div class="field-group">
        <span class="field-label">Account Number</span>
        <input id="acctNumber" type="number" placeholder="10-digit account number">
      </div>
      <div class="field-group">
        <span class="field-label">Amount (‚Ç¶)</span>
        <input id="bankAmount" type="number" placeholder="Amount to withdraw">
        <div class="field-hint">Minimum: ‚Ç¶5,000</div>
      </div>
    </div>

    <!-- CRYPTO FIELDS -->
    <div id="cryptoFields" class="hidden">
      <div class="field-group">
        <span class="field-label">BNB Wallet Address (BEP20)</span>
        <input id="wallet" placeholder="0x...">
      </div>
      <div class="field-group">
        <span class="field-label">Amount ($)</span>
        <input id="cryptoAmount" type="number" placeholder="Amount in USD">
        <div class="field-hint">Minimum: $20</div>
      </div>
    </div>

    <!-- CONTACT -->
    <div class="field-group">
      <span class="field-label">Contact Details</span>
      <input type="tel" id="whatsapp" placeholder="WhatsApp Number">
      <input type="tel" id="phone"    placeholder="Calling Number" style="margin-top:8px;">
    </div>

    <!-- PASSCODE -->
    <div class="passcode-section">
      <span class="field-label">Security Passcode</span>
      <p style="font-size:13px;color:var(--muted);margin-top:6px;line-height:1.6;">
        Generate a one-time passcode sent to your Telegram. This confirms it is really you authorising this withdrawal.
      </p>
      <button class="btn btn-dark" id="genPasscodeBtn">üîë Generate Passcode</button>

      <div class="hidden" id="passcodeBox">
        <input id="passcode" type="number" placeholder="Enter 6-digit passcode from Telegram">
        <div class="passcode-note">
          Check <a href="https://t.me/intelpremiumbot" target="_blank">@intelpremiumbot</a> on Telegram.
          Code expires in 5 minutes.
        </div>
      </div>
    </div>

    <button class="btn btn-blue" id="withdrawBtn" disabled>üí∏ Submit Withdrawal</button>
    <div class="msg" id="msgBox"></div>
  </div>

</div><!-- /container -->

<script>
const tg = window.Telegram?.WebApp;
tg?.ready();

const user       = tg?.initDataUnsafe?.user;
const telegramId = user ? String(user.id) : null;

/* ‚îÄ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ */
document.getElementById("pName").textContent = user?.first_name || "Guest";
document.getElementById("pMeta").textContent =
  (user?.username ? "@" + user.username : "No username") + " ¬∑ ID: " + (telegramId || "N/A");

if (!telegramId) {
  document.getElementById("balNgn").textContent = "‚ùå Open from Telegram";
}

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
let balanceNGN = 0;
let ngnPerUsd  = 1600;

/* ‚îÄ‚îÄ‚îÄ STATUS HELPERS ‚îÄ‚îÄ‚îÄ */
const msgBox = document.getElementById("msgBox");
function showMsg(text, type) {
  if (!text) { msgBox.className = "msg"; return; }
  msgBox.textContent = text;
  msgBox.className   = "msg show " + type;
}

/* ‚îÄ‚îÄ‚îÄ LOAD BALANCE ‚îÄ‚îÄ‚îÄ */
async function loadBalance() {
  if (!telegramId) return;
  try {
    const r = await fetch("/get-balance", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ telegramId })
    });
    const d = await r.json();
    balanceNGN = d?.ngn || 0;
    if (d?.usdRate && d.usdRate > 100) ngnPerUsd = d.usdRate;

    const usd = balanceNGN / ngnPerUsd;
    document.getElementById("balNgn").textContent = "‚Ç¶" + balanceNGN.toLocaleString();
    document.getElementById("balUsd").textContent = "‚âà $" + usd.toFixed(2) + " USD";

    const canBank   = balanceNGN >= 5000;
    const canCrypto = usd >= 20;

    if (!canBank && !canCrypto) {
      document.getElementById("lowMsg").classList.remove("hidden");
    } else {
      document.getElementById("withdrawCard").classList.remove("hidden");
    }
  } catch (err) {
    document.getElementById("balNgn").textContent = "Error";
    showMsg("Failed to load balance: " + err.message, "error");
  }
}
loadBalance();

/* ‚îÄ‚îÄ‚îÄ FIELD TOGGLES ‚îÄ‚îÄ‚îÄ */
document.getElementById("method").onchange = function () {
  document.getElementById("bankFields").classList.toggle("hidden",   this.value !== "bank");
  document.getElementById("cryptoFields").classList.toggle("hidden", this.value !== "crypto");
};
document.getElementById("bank").onchange = function () {
  document.getElementById("otherBank").classList.toggle("hidden", this.value !== "Other");
};

/* ‚îÄ‚îÄ‚îÄ GENERATE PASSCODE ‚îÄ‚îÄ‚îÄ */
const genBtn       = document.getElementById("genPasscodeBtn");
const passcodeBox  = document.getElementById("passcodeBox");
const withdrawBtn  = document.getElementById("withdrawBtn");

genBtn.onclick = async () => {
  if (!telegramId) return showMsg("Open from Telegram.", "error");
  showMsg("‚è≥ Sending passcode to your Telegram...", "loading");
  genBtn.disabled = true;

  try {
    const r = await fetch("/generate-passcode", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ telegramId, purpose: "withdraw" })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || "Failed");

    showMsg("‚úÖ Passcode sent! Check @intelpremiumbot on Telegram.", "success");
    passcodeBox.classList.remove("hidden");
    withdrawBtn.disabled = false;
    genBtn.textContent   = "üîÅ Resend Passcode";
    genBtn.disabled      = false;
  } catch (err) {
    showMsg("‚ùå " + err.message, "error");
    genBtn.disabled = false;
  }
};

/* ‚îÄ‚îÄ‚îÄ SUBMIT WITHDRAWAL ‚îÄ‚îÄ‚îÄ */
withdrawBtn.onclick = async () => {
  if (!telegramId) return showMsg("Open from Telegram.", "error");

  const methodVal   = document.getElementById("method").value;
  const passcodeVal = document.getElementById("passcode").value.trim();

  if (!methodVal)   return showMsg("Select a withdrawal method.", "error");
  if (!passcodeVal) return showMsg("Enter the passcode from Telegram.", "error");

  let amountNGN = 0;

  if (methodVal === "bank") {
    amountNGN = Number(document.getElementById("bankAmount").value);
    if (!amountNGN || amountNGN <= 0) return showMsg("Enter a valid amount.", "error");
    if (amountNGN < 5000)             return showMsg("Minimum bank withdrawal is ‚Ç¶5,000.", "error");
    if (amountNGN > balanceNGN)       return showMsg("Insufficient balance.", "error");
  }

  if (methodVal === "crypto") {
    const usd = Number(document.getElementById("cryptoAmount").value);
    if (!usd || usd <= 0) return showMsg("Enter a valid amount.", "error");
    if (usd < 20)         return showMsg("Minimum crypto withdrawal is $20.", "error");
    amountNGN = Math.round(usd * ngnPerUsd);
    if (amountNGN > balanceNGN) {
      return showMsg(`Insufficient balance. Max: $${(balanceNGN / ngnPerUsd).toFixed(2)}`, "error");
    }
  }

  showMsg("‚è≥ Submitting withdrawal...", "loading");
  withdrawBtn.disabled = true;

  const bankEl = document.getElementById("bank");

  try {
    const r = await fetch("/withdraw", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        telegramId,
        method:   methodVal,
        amount:   amountNGN,
        passcode: passcodeVal,
        details: {
          bank:          bankEl.value === "Other" ? document.getElementById("otherBank").value : bankEl.value,
          accountName:   document.getElementById("acctName").value,
          accountNumber: document.getElementById("acctNumber").value,
          wallet:        document.getElementById("wallet").value,
          whatsapp:      document.getElementById("whatsapp").value,
          phone:         document.getElementById("phone").value
        }
      })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || "Withdrawal failed");

    balanceNGN = d.newBalance;
    document.getElementById("balNgn").textContent = "‚Ç¶" + balanceNGN.toLocaleString();
    document.getElementById("balUsd").textContent = "‚âà $" + (balanceNGN / ngnPerUsd).toFixed(2) + " USD";

    showMsg("‚úÖ Withdrawal submitted! You will be paid shortly.", "success");
  } catch (err) {
    showMsg("‚ùå " + err.message, "error");
    withdrawBtn.disabled = false;
  }
};
</script>

</body>
</html>
