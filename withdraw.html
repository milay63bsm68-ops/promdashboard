<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Withdraw</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }
body {
  background:#020617;
  color:white;
  font-family:Arial, sans-serif;
  padding:14px;
  margin:0;
  overflow-x:hidden;
}

.container { max-width:420px; margin:0 auto; }

.card {
  background:#0f172a;
  padding:14px;
  border-radius:14px;
  margin-bottom:12px;
}

h3 { margin:0 0 8px 0; font-size:14px; font-weight:bold; }

input, select {
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:10px;
  border:none;
  background:#020617;
  color:white;
  font-size:14px;
}

button {
  width:100%;
  padding:12px;
  margin-top:12px;
  border:none;
  border-radius:12px;
  background:#3b82f6;
  color:white;
  font-weight:bold;
  font-size:14px;
}

button:disabled { opacity:0.5; }

.msg {
  margin-top:10px;
  padding:8px;
  border-radius:8px;
  font-size:13px;
}

.error { background:#ef4444; }
.success { background:#22c55e; }
.loading { background:#facc15; color:black; }

.small { font-size:12px; opacity:0.75; }

.hidden { display:none; }
</style>
</head>

<body>

<div class="container">

  <!-- USER INFO -->
  <div class="card" id="userInfo">Loading user…</div>

  <!-- BALANCE -->
  <div class="card" id="balanceBox">Loading balance…</div>

  <!-- MESSAGE FOR LOW BALANCE -->
  <div class="card hidden" id="lowBalanceMsg">
    <div class="msg error">
      Minimum balance required to withdraw:<br>
      ₦5,000 for bank transfer<br>
      $20 for crypto
    </div>
    <button onclick="window.location.reload()">Go Back</button>
  </div>

  <!-- WITHDRAW FORM -->
  <div class="card hidden" id="withdrawForm">

    <h3>Withdrawal Method</h3>
    <select id="method">
      <option value="">Select method</option>
      <option value="bank">Bank Transfer (₦)</option>
      <option value="crypto">Crypto (BNB BEP20)</option>
    </select>

    <!-- BANK -->
    <div id="bankFields" class="hidden">
      <h3 style="margin-top:10px">Bank Details</h3>
      <select id="bank">
        <option value="">Select Bank</option>
        <option>Opay</option>
        <option>PalmPay</option>
        <option>Moniepoint</option>
        <option>GTBank</option>
        <option>Access Bank</option>
        <option>Zenith Bank</option>
        <option>UBA</option>
        <option>First Bank</option>
        <option>FCMB</option>
        <option>Other</option>
      </select>
      <input id="otherBank" placeholder="Other bank name" class="hidden">
      <input id="acctName" placeholder="Account Name">
      <input id="acctNumber" placeholder="Account Number">
      <input id="bankAmount" type="number" placeholder="Amount (₦)">
      <div class="small">Minimum: ₦5,000</div>
    </div>

    <!-- CRYPTO -->
    <div id="cryptoFields" class="hidden">
      <h3 style="margin-top:10px">Crypto Details</h3>
      <input id="wallet" placeholder="BNB Smart Chain (BEP20) Address">
      <input id="cryptoAmount" type="number" placeholder="Amount ($)">
      <div class="small">Minimum: $20</div>
    </div>

    <!-- CONTACT -->
    <h3 style="margin-top:10px">Contact Details</h3>
    <input id="whatsapp" placeholder="WhatsApp Number">
    <input id="phone" placeholder="Calling Number">

    <button id="withdrawBtn" onclick="withdraw()" disabled>
      Submit Withdrawal
    </button>

    <div id="msgBox"></div>
  </div>

</div>

<script>
const API = "https://promdashboard.onrender.com";
const tg = window.Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe?.user;
const telegramId = user ? String(user.id) : null;

const userInfo = document.getElementById("userInfo");
const balanceBox = document.getElementById("balanceBox");
const msgBox = document.getElementById("msgBox");
const withdrawBtn = document.getElementById("withdrawBtn");
const withdrawForm = document.getElementById("withdrawForm");
const lowBalanceMsg = document.getElementById("lowBalanceMsg");

let balanceNGN = 0;
let usdRate = 0;

// Display user info
userInfo.innerHTML = `
<b>Name:</b> ${user?.first_name || "N/A"}<br>
<b>Username:</b> ${user?.username ? "@"+user.username : "N/A"}<br>
<b>ID:</b> ${telegramId || "N/A"}
`;

function showMsg(text, type="success") {
  msgBox.innerHTML = text ? `<div class="msg ${type}">${text}</div>` : "";
}

// Fetch real USD rate
async function fetchUsdRate() {
  try {
    const res = await fetch("https://api.exchangerate-api.com/v4/latest/NGN");
    const data = await res.json();
    return data.rates.USD || 0.0026;
  } catch {
    return 0.0026;
  }
}

// Load user balance
async function loadBalance() {
  showMsg("Loading balance…", "loading");
  try {
    const r = await fetch(API + "/get-balance", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ telegramId })
    });
    const d = await r.json();
    balanceNGN = d?.ngn || 0;

    usdRate = await fetchUsdRate(); // fetch USD rate
    const usd = balanceNGN * usdRate;

    balanceBox.innerHTML =
      `<b>Balance:</b><br>₦${balanceNGN.toLocaleString()} ≈ $${usd.toFixed(2)}`;

    if (balanceNGN < 5000 && usd < 20) {
      lowBalanceMsg.classList.remove("hidden");
      withdrawForm.classList.add("hidden");
    } else {
      withdrawForm.classList.remove("hidden");
      lowBalanceMsg.classList.add("hidden");
      withdrawBtn.disabled = false;
    }
    showMsg("");
  } catch (err) {
    showMsg("Failed to load balance: "+err.message, "error");
    withdrawForm.classList.add("hidden");
    lowBalanceMsg.classList.add("hidden");
  }
}
loadBalance();

// Show/hide fields
method.onchange = () => {
  bankFields.style.display = method.value==="bank" ? "block" : "none";
  cryptoFields.style.display = method.value==="crypto" ? "block" : "none";
};
bank.onchange = () => {
  otherBank.style.display = bank.value==="Other" ? "block" : "none";
};

// Withdraw function
async function withdraw() {
  const methodVal = method.value;
  if (!methodVal) return showMsg("Select withdrawal method", "error");

  let amountNGN = 0;
  if (methodVal === "bank") {
    amountNGN = Number(bankAmount.value);
    if (amountNGN < 5000) return showMsg("Minimum bank withdrawal is ₦5,000", "error");
    if (amountNGN > balanceNGN) return showMsg("Insufficient balance", "error");
  }
  if (methodVal === "crypto") {
    const usd = Number(cryptoAmount.value);
    if (usd < 20) return showMsg("Minimum crypto withdrawal is $20", "error");
    amountNGN = usd / usdRate;
    if (amountNGN > balanceNGN) return showMsg("Insufficient balance", "error");
  }

  showMsg("Submitting withdrawal…", "loading");
  withdrawBtn.disabled = true;

  try {
    const res = await fetch(API + "/withdraw", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        telegramId,
        method: methodVal,
        amount: Math.round(amountNGN),
        details: {
          bank: bank.value==="Other" ? otherBank.value : bank.value,
          accountName: acctName.value,
          accountNumber: acctNumber.value,
          wallet: wallet.value,
          whatsapp: whatsapp.value,
          phone: phone.value
        },
        initData: tg.initData // SEND initData for Telegram WebApp verification
      })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Withdrawal failed");

    showMsg("✅ Withdrawal submitted successfully!", "success");
    balanceNGN = data.newBalance;
    balanceBox.innerHTML =
      `<b>Balance:</b><br>₦${balanceNGN.toLocaleString()} ≈ $${(balanceNGN*usdRate).toFixed(2)}`;

    // Notify admin
    await fetch(API + "/notify-admin", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        message: `User ${telegramId} completed withdrawal of ₦${Math.round(amountNGN)} via ${methodVal}`
      })
    });

    withdrawBtn.disabled = true;

  } catch (err) {
    showMsg("❌ Withdrawal failed: "+err.message, "error");
    withdrawBtn.disabled = false;
  }
}
</script>

</body>
</html>