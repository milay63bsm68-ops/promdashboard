<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Withdraw</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { box-sizing: border-box; }
body { background:#020617; color:white; font-family:Arial, sans-serif; padding:14px; margin:0; }
.container { max-width:420px; margin:0 auto; }
.card { background:#0f172a; padding:14px; border-radius:14px; margin-bottom:12px; }
h3 { margin:0 0 8px 0; font-size:14px; }
input, select { width:100%; padding:10px; margin-top:6px; border-radius:10px; border:none; background:#020617; color:white; font-size:14px; height:50px; }
button { width:100%; padding:12px; margin-top:12px; border:none; border-radius:12px; background:#3b82f6; color:white; font-weight:bold; }
button:disabled { opacity:0.5; }
.msg { margin-top:10px; padding:8px; border-radius:8px; font-size:13px; }
.error { background:#ef4444; }
.success { background:#22c55e; }
.loading { background:#facc15; color:black; }
.hidden { display:none; }
.small { font-size:12px; opacity:0.75; }
</style>
</head>

<body>
<div class="container">

  <div class="card" id="userInfo">Loading user…</div>
  <div class="card" id="balanceBox">Loading balance…</div>

  <div class="card hidden" id="lowBalanceMsg">
    <div class="msg error">
      Minimum withdrawal:<br>
      ₦5,000 (Bank)<br>
      $20 (Crypto)
    </div>
  </div>

  <div class="card hidden" id="withdrawForm">
    <h3>Withdrawal Method</h3>
    <select id="method">
      <option value="">Select method</option>
      <option value="bank">Bank Transfer (₦)</option>
      <option value="crypto">Crypto (BNB BEP20)</option>
    </select>

    <div id="bankFields" class="hidden">
      <h3>Bank Details</h3>
      <select id="bank">
        <option value="">Select Bank</option>
        <option>Opay</option>
        <option>PalmPay</option>
        <option>Moniepoint</option>
        <option>GTBank</option>
        <option>Access Bank</option>
        <option>Zenith Bank</option>
        <option>UBA</option>
        <option>Other</option>
      </select>
      <input id="otherBank" placeholder="Other bank name" class="hidden">
      <input id="acctName" placeholder="Account Name">
      <input id="acctNumber" placeholder="Account Number">
      <input id="bankAmount" type="number" placeholder="Amount (₦)">
    </div>

    <div id="cryptoFields" class="hidden">
      <h3>Crypto Details</h3>
      <input id="wallet" placeholder="BNB BEP20 Address">
      <input id="cryptoAmount" type="number" placeholder="Amount ($)">
    </div>

    <h3>Contact</h3>
    <input id="whatsapp" placeholder="WhatsApp Number">
    <input id="phone" placeholder="Phone Number">

    <button id="generatePasscodeBtn">Generate Withdrawal Passcode</button>
    <input id="passcode" placeholder="Enter passcode" class="hidden">
    <button id="withdrawBtn" class="hidden">Submit Withdrawal</button>
    <div id="msgBox"></div>
  </div>

</div>

<script>
const userInfo = document.getElementById("userInfo");
const balanceBox = document.getElementById("balanceBox");
const withdrawForm = document.getElementById("withdrawForm");
const lowBalanceMsg = document.getElementById("lowBalanceMsg");
const msgBox = document.getElementById("msgBox");

const method = document.getElementById("method");
const bank = document.getElementById("bank");
const otherBank = document.getElementById("otherBank");
const bankAmount = document.getElementById("bankAmount");
const cryptoAmount = document.getElementById("cryptoAmount");
const wallet = document.getElementById("wallet");
const acctName = document.getElementById("acctName");
const acctNumber = document.getElementById("acctNumber");
const whatsapp = document.getElementById("whatsapp");
const phone = document.getElementById("phone");

const generatePasscodeBtn = document.getElementById("generatePasscodeBtn");
const passcodeInput = document.getElementById("passcode");
const withdrawBtn = document.getElementById("withdrawBtn");

let balanceNGN = 0;
let usdRate = 0.0026;

// Simple message display
function showMsg(text,type="success"){
  msgBox.innerHTML = text ? `<div class="msg ${type}">${text}</div>` : "";
}

// Fetch USD rate
async function fetchUsdRate(){
  try{
    const r = await fetch("https://api.exchangerate-api.com/v4/latest/NGN");
    const d = await r.json();
    usdRate = d.rates.USD || usdRate;
  }catch{}
}

// Load balance
async function loadBalance(){
  showMsg("Loading balance…","loading");

  try{
    const res = await fetch("/get-balance",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({})
    });

    const data = await res.json();
    balanceNGN = data.ngn || 0;

    await fetchUsdRate();

    balanceBox.innerHTML =
      `<b>Balance:</b><br>₦${balanceNGN.toLocaleString()} ≈ $${(balanceNGN*usdRate).toFixed(2)}`;

    if(balanceNGN < 5000 && balanceNGN*usdRate < 20){
      lowBalanceMsg.classList.remove("hidden");
      withdrawForm.classList.add("hidden");
    }else{
      withdrawForm.classList.remove("hidden");
      lowBalanceMsg.classList.add("hidden");
    }

    showMsg("");
  }catch(err){
    showMsg("Failed to load balance","error");
  }
}

loadBalance();

// Show/hide fields
method.onchange = () => {
  document.getElementById("bankFields").classList.toggle("hidden", method.value !== "bank");
  document.getElementById("cryptoFields").classList.toggle("hidden", method.value !== "crypto");
};
bank.onchange = () => {
  otherBank.classList.toggle("hidden", bank.value !== "Other");
};

// Generate passcode
generatePasscodeBtn.onclick = async () => {
  showMsg("Generating passcode…","loading");
  generatePasscodeBtn.disabled = true;

  try{
    const res = await fetch("/generate-passcode",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({})
    });

    const data = await res.json();
    if(!res.ok) throw new Error(data.error);

    showMsg(`✅ Passcode sent via Telegram. Enter it below.`,"success");
    passcodeInput.classList.remove("hidden");
    withdrawBtn.classList.remove("hidden");
  }catch(err){
    showMsg(err.message,"error");
    generatePasscodeBtn.disabled = false;
  }
};

// Submit withdrawal
withdrawBtn.onclick = async () => {
  const m = method.value;
  if(!m) return showMsg("Select withdrawal method","error");

  let amount = 0;
  if(m === "bank"){
    amount = Number(bankAmount.value);
    if(amount < 5000) return showMsg("Minimum ₦5,000","error");
    if(amount > balanceNGN) return showMsg("Insufficient balance","error");
  }
  if(m === "crypto"){
    amount = Number(cryptoAmount.value);
    if(amount < 20) return showMsg("Minimum $20","error");
  }

  const passcode = passcodeInput.value.trim();
  if(!passcode) return showMsg("Enter your passcode","error");

  showMsg("Submitting withdrawal…","loading");
  withdrawBtn.disabled = true;

  try{
    const res = await fetch("/withdraw",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        method: m,
        amount,
        passcode,
        details:{
          bank: bank.value==="Other"?otherBank.value:bank.value,
          accountName: acctName.value,
          accountNumber: acctNumber.value,
          wallet: wallet.value,
          whatsapp: whatsapp.value,
          phone: phone.value
        }
      })
    });

    const data = await res.json();
    if(!res.ok) throw new Error(data.error);

    showMsg("✅ Withdrawal submitted","success");
    balanceNGN = data.newBalance;
    balanceBox.innerHTML =
      `<b>Balance:</b><br>₦${balanceNGN.toLocaleString()} ≈ $${(balanceNGN*usdRate).toFixed(2)}`;
  }catch(err){
    showMsg(err.message,"error");
    withdrawBtn.disabled = false;
  }
};
</script>
</body>
</html>